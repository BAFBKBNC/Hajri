<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Add Event - ClassCount Pro</title>
<style>
  :root {
    --primary-color: #4f46e5;
    --primary-hover: #4338ca;
    --secondary-color: #10b981;
    --danger-color: #ef4444;
    --light-gray: #f3f4f6;
    --medium-gray: #d1d5db;
    --dark-gray: #374151;
    --text-color: #1f2937;
    --white: #ffffff;
    --font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    --border-radius: 0.5rem;
    --box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  }

  body {
    font-family: var(--font-family);
    margin: 0;
    background-color: var(--light-gray);
    color: var(--text-color);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  header {
    background: var(--white);
    padding: 1rem 2rem;
    text-align: center;
    border-bottom: 1px solid var(--medium-gray);
    box-shadow: var(--box-shadow);
  }

  header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0;
    color: var(--primary-color);
  }

  main {
    flex-grow: 1;
    padding: 2rem 1rem;
    max-width: 1200px;
    width: 100%;
    margin: 0 auto;
    box-sizing: border-box;
  }
  
  .container {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 2rem;
    box-shadow: var(--box-shadow);
  }
  
  .form-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }

  @media (min-width: 768px) {
    .form-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    .grid-span-2 {
      grid-column: span 2 / span 2;
    }
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
  }

  label {
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
  }

  input[type="date"],
  input[type="text"],
  input[type="time"] {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--medium-gray);
    border-radius: var(--border-radius);
    font-size: 1rem;
    transition: border-color 0.2s, box-shadow 0.2s;
    box-sizing: border-box;
  }

  input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgb(79 70 229 / 0.2);
  }

  .student-list-container {
      border: 1px solid var(--medium-gray);
      border-radius: var(--border-radius);
      background: var(--white);
  }
  
  .student-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.8rem 1rem;
    border-bottom: 1px solid var(--light-gray);
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s;
  }
  
  .student-item:last-child { border-bottom: none; }
  .student-item:hover { background-color: #f9fafb; }
  .student-item.selected {
    background-color: #eef2ff;
    font-weight: 600;
  }

  .student-item::before {
    content: '';
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid var(--medium-gray);
    border-radius: 50%;
    transition: background-color 0.2s, border-color 0.2s;
  }

  .student-item.selected::before {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
    background-size: 100% 100%;
  }

  .student-name { flex: 1 1 auto; }
  .student-id {
      font-size: 0.8rem;
      color: #6b7280;
      background-color: var(--light-gray);
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
  }

  .btn {
    width: 100%;
    color: var(--white);
    padding: 0.8rem 1rem;
    border: none;
    border-radius: var(--border-radius);
    font-weight: 700;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.2s, transform 0.1s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
  .btn:hover { transform: translateY(-1px); }
  .btn:active { transform: translateY(0); }

  .btn-primary { background-color: var(--primary-color); }
  .btn-primary:hover { background-color: var(--primary-hover); }
  .btn-secondary { background-color: var(--secondary-color); }
  .btn-secondary:hover { background-color: #059669; }
  .btn-danger { background-color: var(--danger-color); }
  .btn-danger:hover { background-color: #dc2626; }
  
  .qr-section {
    text-align: center;
    margin-top: 1rem;
    border: 1px dashed var(--medium-gray);
    padding: 1rem;
    border-radius: var(--border-radius);
  }
  #qr-reader {
    width: 100%;
    max-width: 350px;
    margin: 1rem auto 0;
    border-radius: var(--border-radius);
    overflow: hidden;
  }

  .toast {
    position: fixed;
    bottom: -100px;
    left: 50%;
    transform: translateX(-50%);
    padding: 1rem 2rem;
    border-radius: var(--border-radius);
    color: var(--white);
    font-weight: 600;
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    transition: bottom 0.5s ease-in-out;
    z-index: 1000;
  }
  .toast.show { bottom: 20px; }
  .toast.success { background-color: var(--secondary-color); }
  .toast.error { background-color: var(--danger-color); }

</style>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const SUPABASE_URL = "https://pwgdubtbvqnmivtupbvx.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3Z2R1YnRidnFubWl2dHVwYnZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwOTUzMTAsImV4cCI6MjA3MDY3MTMxMH0.kCn6JMv0kTQrkoJ7OmaxCbwZNzewRNtuOg-35nYXYXg";
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  /* --- Helpers --- */
  function getCourse() {
    const urlParams = new URLSearchParams(window.location.search);
    return (urlParams.get("course") || "sybaf").toLowerCase();
  }
  
  function toDDMMYYYY(dateString) {
      if (!dateString) return '';
      const [y, m, d] = dateString.split("-");
      return `${d}/${m}/${y}`;
  }

  function to12HourFormat(timeStr) {
    if (!timeStr) return '';
    let [hour, minute] = timeStr.split(":").map(Number);
    const ampm = hour >= 12 ? "PM" : "AM";
    hour = hour % 12 || 12; // Convert hour to 12-hour format
    return `${hour}:${minute.toString().padStart(2, "0")} ${ampm}`;
  }
  
  function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 500);
      }, 3000);
  }

  /* --- State --- */
  const course = getCourse();
  let students = [];
  const selectedIds = new Set();
  let html5QrCode;
  const beepSound = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

  /* --- DOM Elements --- */
  const studentListEl = document.getElementById("student-list");
  const searchEl = document.getElementById("student-search");
  const startQrBtn = document.getElementById("start-qr-btn");
  const closeQrBtn = document.getElementById("close-qr-btn");
  const qrReaderEl = document.getElementById("qr-reader");
  const formEl = document.getElementById("event-form");
  const submitBtn = document.getElementById("submit-btn");

  /* --- Core Functions --- */
  function renderStudents(studentData) {
    studentListEl.innerHTML = "";
    if (!studentData || studentData.length === 0) {
      studentListEl.innerHTML = `<div class="student-item">No students found.</div>`;
      return;
    }
    
    for (const student of studentData) {
      const item = document.createElement("div");
      item.className = "student-item";
      if (selectedIds.has(student.id)) {
        item.classList.add("selected");
      }
      
      item.innerHTML = `
        <span class="student-name" title="${student.name}">${student.name}</span>
        <span class="student-id">${student.id}</span>
      `;
      
      item.addEventListener("click", () => toggleSelect(student.id));
      studentListEl.appendChild(item);
    }
  }

  function toggleSelect(id) {
    if (selectedIds.has(id)) {
      selectedIds.delete(id);
    } else {
      selectedIds.add(id);
    }
    filterAndRender(); 
  }

  function filterAndRender() {
    const query = searchEl.value.toLowerCase();
    const filteredStudents = students.filter(s => s.name.toLowerCase().includes(query));
    renderStudents(filteredStudents);
  }

  async function loadStudents() {
    const tableName = `${course}_students`;
    const { data, error } = await supabase.from(tableName).select("id, name").order("name");
    
    if (error) {
      console.error("Error fetching students:", error);
      showToast(`Error fetching students: ${error.message}`, 'error');
      return;
    }
    students = data || [];
    renderStudents(students);
  }

  /* --- Event Listeners --- */
  searchEl.addEventListener("input", filterAndRender);

  startQrBtn.addEventListener("click", () => {
    qrReaderEl.style.display = "block";
    startQrBtn.style.display = "none";
    closeQrBtn.style.display = "inline-block";

    html5QrCode = new Html5Qrcode("qr-reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: { width: 250, height: 250 } },
      (qrCodeMessage) => {
        const scannedId = parseInt(qrCodeMessage, 10);
        if (students.some(s => s.id === scannedId) && !selectedIds.has(scannedId)) {
          selectedIds.add(scannedId);
          filterAndRender();
          beepSound.play();
          showToast(`Added ID: ${scannedId}`, 'success');
        }
      },
      (errorMessage) => { /* ignore errors */ }
    ).catch(err => console.error("QR start failed", err));
  });
  
  closeQrBtn.addEventListener("click", () => {
    if (html5QrCode && html5QrCode.isScanning) {
      html5QrCode.stop().finally(() => {
        qrReaderEl.style.display = "none";
        startQrBtn.style.display = "inline-block";
        closeQrBtn.style.display = "none";
      });
    }
  });

  formEl.addEventListener("submit", async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.textContent = "Saving...";

    const eventName = document.getElementById("event-name").value;
    const dateISO = document.getElementById("event-date").value;
    const startTime = document.getElementById("event-start-time").value;
    const endTime = document.getElementById("event-end-time").value;

    if (!eventName || !dateISO || !startTime || !endTime) {
      showToast("Please fill all event details.", 'error');
      submitBtn.disabled = false;
      submitBtn.textContent = "Save Event";
      return;
    }

    const eventData = {
      EVENTS: eventName,
      DATE: toDDMMYYYY(dateISO),
      TIME: `${to12HourFormat(startTime)} - ${to12HourFormat(endTime)}`,
      participants: Array.from(selectedIds).map(String)
    };
    
    const eventsTable = `${course}_events`;
    const { error } = await supabase.from(eventsTable).insert([eventData]);

    if (error) {
      showToast(`Error saving event: ${error.message}`, 'error');
    } else {
      showToast("Event saved successfully! ✅", 'success');
      selectedIds.clear();
      formEl.reset();
      filterAndRender();
    }

    submitBtn.disabled = false;
    submitBtn.textContent = "Save Event";
  });

  // --- Initial Load ---
  window.addEventListener("DOMContentLoaded", loadStudents);
</script>
</head>
<body>
  <header><h1>Add Event</h1></header>

  <main>
    <form id="event-form" class="container">
      <div class="form-grid">
        <div class="form-group grid-span-2">
          <label for="event-name">Event Name</label>
          <input type="text" id="event-name" required placeholder="e.g., Annual Sports Day" />
        </div>

        <div class="form-group">
          <label for="event-date">Date</label>
          <input type="date" id="event-date" required />
        </div>

        <div class="form-group">
            </div>

        <div class="form-group">
          <label for="event-start-time">Start Time</label>
          <input type="time" id="event-start-time" required />
        </div>

        <div class="form-group">
          <label for="event-end-time">End Time</label>
          <input type="time" id="event-end-time" required />
        </div>

        <div class="form-group grid-span-2">
            <label for="student-search">Search & Select Participants</label>
            <input type="text" id="student-search" placeholder="Search by name..." />
        </div>

        <div class="qr-section grid-span-2">
            <button type="button" id="start-qr-btn" class="btn btn-secondary">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm11.5 5.5a.5.5 0 0 0 0-1h-1a.5.5 0 0 0 0 1zm-1 1a.5.5 0 0 0-1 0V12a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5V8a.5.5 0 0 0-.5-.5M6 6h4v4H6zM5 5h6v6H5zM3 6.5a.5.5 0 0 0 1 0v-1a.5.5 0 0 0-1 0zm-1.5.5a.5.5 0 0 0 0-1h-1a.5.5 0 0 0 0 1zM2 9.5a.5.5 0 0 0 1 0v-1a.5.5 0 0 0-1 0zm-1.5.5a.5.5 0 0 0 0-1h-1a.5.5 0 0 0 0 1z"/></svg>
              Scan Participant QR
            </button>
            <button type="button" id="close-qr-btn" class="btn btn-danger" style="display:none;">Close Scanner</button>
            <div id="qr-reader" style="display:none;"></div>
        </div>
        
        <div class="student-list-container grid-span-2">
          <div id="student-list">
              </div>
        </div>

        <div class="grid-span-2">
          <button type="submit" id="submit-btn" class="btn btn-primary">Save Event</button>
        </div>
      </div>
    </form>
  </main>
</body>
</html>
