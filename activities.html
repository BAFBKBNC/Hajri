<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Activities - ClassCount</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/lucide/dist/umd/lucide.min.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .header-gradient { background: linear-gradient(90deg, #4f46e5, #7c3aed); }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="flex min-h-screen">
  <div class="hidden md:flex flex-col w-64 bg-gray-900 text-gray-200 shadow-xl">
    <div class="flex items-center justify-center h-20 header-gradient text-white">
      <i data-lucide="graduation-cap" class="h-8 w-8 mr-3"></i>
      <span class="text-2xl font-bold">ClassCount</span>
    </div>
    <nav class="flex flex-col flex-grow p-4">
      <a href="dashboard.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="layout-dashboard" class="h-5 w-5 mr-3"></i>
        <span>Dashboard</span>
      </a>
      <a href="students.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="users" class="h-5 w-5 mr-3"></i>
        <span>Students</span>
      </a>
      <a href="blacklist.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="shield-alert" class="h-5 w-5 mr-3"></i>
        <span>Blacklist</span>
      </a>
      <a href="fplist.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="clipboard-list" class="h-5 w-5 mr-3"></i>
        <span>FP List</span>
      </a>
      <a href="lectures.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="book-open" class="h-5 w-5 mr-3"></i>
        <span>Lectures</span>
      </a>
      <a href="activities.html" class="flex items-center px-4 py-3 mt-2 font-semibold text-white bg-indigo-600 rounded-lg shadow-md">
        <i data-lucide="puzzle" class="h-5 w-5 mr-3"></i>
        <span>Activities</span>
      </a>
      <a href="changepassword.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="key-round" class="h-5 w-5 mr-3"></i>
        <span>Change Password</span>
      </a>
      <a href="#" id="logout-btn" class="flex items-center px-4 py-3 mt-2 text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors duration-200">
        <i data-lucide="log-out" class="h-5 w-5 mr-3"></i>
        <span>Logout</span>
      </a>
    </nav>
  </div>

  <div class="flex flex-col flex-1 overflow-y-auto">
    <header class="flex items-center justify-between h-20 px-4 sm:px-8 bg-white border-b shadow-sm sticky top-0 z-10">
      <h1 id="page-title" class="text-xl sm:text-2xl font-bold text-gray-900">Activities</h1>
      <div class="flex items-center space-x-4">
        <div class="text-sm text-gray-600 text-right">
          <p id="prof-name" class="font-semibold">Prof. ...</p>
        </div>
        <div id="prof-initial" class="w-12 h-12 rounded-full bg-indigo-600 text-white flex items-center justify-center text-xl font-bold border-2 border-indigo-300">
          ?
        </div>
      </div>
    </header>

    <main class="p-4 sm:p-8">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-700">All Scheduled Activities</h2>
      </div>

      <div id="activities-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        </div>
    </main>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const SUPABASE_URL = "https://pwgdubtbvqnmivtupbvx.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3Z2R1YnRidnFubWl2dHVwYnZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwOTUzMTAsImV4cCI6MjA3MDY3MTMxMH0.kCn6JMv0kTQrkoJ7OmaxCbwZNzewRNtuOg-35nYXYXg";
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  const activitiesContainer = document.getElementById("activities-container");

  // --- Helper Functions ---
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

  function showStatusMessage(container, message) {
    container.innerHTML = `<div class="md:col-span-2 xl:col-span-3 bg-white p-8 rounded-lg shadow-md text-center text-gray-500 font-medium">${message}</div>`;
  }

  function createActivityCard(activity, course) {
    const participantCount = Array.isArray(activity.attendees) ? activity.attendees.length : 0;
    
    const card = document.createElement("div");
    card.className = "bg-white rounded-lg shadow-md p-6 flex flex-col hover:shadow-xl hover:-translate-y-1 transition-all duration-300";

    // NEW: Changed icon tags in the template
    card.innerHTML = `
      <h3 class="text-xl font-bold text-gray-800 mb-2">${activity.EVENTS}</h3>
      <div class="flex items-center space-x-4 text-gray-500 text-sm mb-4">
        <div class="flex items-center gap-1.5">
          <i data-lucide="calendar" class="h-4 w-4"></i>
          <span>${activity.DATE}</span>
        </div>
        <div class="flex items-center gap-1.5">
          <i data-lucide="clock" class="h-4 w-4"></i>
          <span>${activity.TIME}</span>
        </div>
      </div>
      <div class="text-lg font-semibold text-purple-600 mb-6">
        ${participantCount} Participants
      </div>
      <a href="admineventsattendence.html?no=${activity.NO}&course=${course}" class="mt-auto text-center w-full bg-indigo-600 text-white font-semibold py-2.5 rounded-lg hover:bg-indigo-700 transition-colors">
        View Participants
      </a>
    `;
    return card;
  }

  // --- Data Loading ---
  async function loadActivities(course) {
    showStatusMessage(activitiesContainer, 'Loading activities...');
    
    const tableName = `${course}_events`;
    const { data, error } = await supabase
      .from(tableName)
      .select("*")
      .order("NO", { ascending: false });

    if (error) {
      console.error("Error fetching activities:", error);
      showStatusMessage(activitiesContainer, "Could not load activities. Please check your connection and try again.");
      return;
    }
    
    activitiesContainer.innerHTML = "";
    
    if (data.length === 0) {
      showStatusMessage(activitiesContainer, "No activities have been scheduled yet.");
      return;
    }
    
    data.forEach(activity => {
      const card = createActivityCard(activity, course);
      activitiesContainer.appendChild(card);
    });
  }

  // --- Initial Load & Event Listeners ---
  document.addEventListener('DOMContentLoaded', async () => { // NEW: made async
    // --- Auth & Profile Setup ---
    const course = getCookie("course");
    const profName = getCookie("name");

    if (!course) {
      window.location.href = "adminlogin.html";
      return;
    }

    if (profName) {
      const decodedName = decodeURIComponent(profName.replace(/\+/g, ' '));
      document.getElementById('prof-name').textContent = `Prof. ${decodedName}`;
      document.getElementById('prof-initial').textContent = decodedName.charAt(0).toUpperCase();
    }
    
    document.getElementById('page-title').textContent = `${course.toUpperCase().replace('_', ' ')} Activities`;
    
    // --- Logout ---
    document.getElementById('logout-btn').addEventListener('click', (e) => {
      e.preventDefault();
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i];
        const eqPos = cookie.indexOf("=");
        const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
        document.cookie = name.trim() + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
      }
      window.location.href = "adminlogin.html";
    });

    // --- Load Data & Render Icons ---
    await loadActivities(course); // NEW: await the data loading
    lucide.createIcons(); // NEW: Render icons after everything is loaded
  });
</script>

</body>
</html>
