<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student List | ClassCount</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/lucide/dist/umd/lucide.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06); }
    .header-gradient { background: linear-gradient(90deg, #4f46e5, #7c3aed); }
    .badge-safe { background-color: #dcfce7; color: #166534; }
    .badge-warning { background-color: #fef9c3; color: #854d0e; }
    .badge-danger { background-color: #fee2e2; color: #991b1b; }
    /* Custom style for the select dropdown */
    select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='lucide lucide-chevron-down'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.5rem center;
        background-size: 1.2em;
        padding-right: 2.5rem;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="flex min-h-screen">
  <div class="hidden md:flex flex-col w-64 bg-gray-900 text-gray-200 shadow-xl">
    <div class="flex items-center justify-center h-20 header-gradient text-white">
      <i data-lucide="graduation-cap" class="h-8 w-8 mr-3"></i>
      <span class="text-2xl font-bold">ClassCount</span>
    </div>
    <nav class="flex flex-col flex-grow p-4">
      <a href="dashboard.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="layout-dashboard" class="h-5 w-5 mr-3"></i>
        <span>Dashboard</span>
      </a>
      <a href="students.html" class="flex items-center px-4 py-3 mt-2 font-semibold text-white bg-indigo-600 rounded-lg shadow-md">
        <i data-lucide="users" class="h-5 w-5 mr-3"></i>
        <span>Students</span>
      </a>
      <a href="blacklist.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="shield-alert" class="h-5 w-5 mr-3"></i>
        <span>Blacklist</span>
      </a>
      <a href="fplist.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="clipboard-list" class="h-5 w-5 mr-3"></i>
        <span>FP List</span>
      </a>
      <a href="lectures.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="book-open" class="h-5 w-5 mr-3"></i>
        <span>Lectures</span>
      </a>
      <a href="activities.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="puzzle" class="h-5 w-5 mr-3"></i>
        <span>Activities</span>
      </a>
      <a href="changeadminpassword.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="key-round" class="h-5 w-5 mr-3"></i>
        <span>Change Password</span>
      </a>
      <a href="#" id="logout-btn" class="flex items-center px-4 py-3 mt-2 text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors duration-200">
        <i data-lucide="log-out" class="h-5 w-5 mr-3"></i>
        <span>Logout</span>
      </a>
    </nav>
  </div>

  <div class="flex flex-col flex-1 overflow-y-auto">
    <header class="flex items-center justify-between h-20 px-4 sm:px-8 bg-white border-b shadow-sm sticky top-0 z-10">
      <h1 id="page-title" class="text-xl sm:text-2xl font-bold text-gray-900">Student Records</h1>
      <div class="flex items-center space-x-4">
        <div class="text-sm text-gray-600 text-right">
          <p id="prof-name" class="font-semibold">Prof. ...</p>
          <p id="current-date" class="text-xs"></p>
        </div>
        <div id="prof-initial" class="w-12 h-12 rounded-full bg-indigo-600 text-white flex items-center justify-center text-xl font-bold border-2 border-indigo-300">
          ?
        </div>
      </div>
    </header>

    <main class="p-4 sm:p-8">
      <div class="card p-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <i data-lucide="list-checks" class="h-5 w-5 text-indigo-600"></i>
            All Students
          </h2>
          <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 w-full sm:w-auto">
             <select id="subject-filter" class="px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white w-full sm:w-48">
               <option value="All">All Subjects</option>
           </select>
            <input id="search-box" type="text" placeholder="Search by name or ID"
              class="px-3 py-2 border rounded-lg text-sm w-full sm:w-48 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button onclick="downloadExcel()"
              class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 flex items-center justify-center gap-2 transition-colors">
              <i data-lucide="download" class="h-4 w-4"></i>
              <span>Excel</span>
            </button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table id="student-table" class="w-full text-left border-collapse">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-4 cursor-pointer font-semibold text-gray-600" onclick="sortTable(0)">ID</th>
                <th class="p-4 cursor-pointer font-semibold text-gray-600" onclick="sortTable(1)">Student Name</th>
                <th id="attendance-header" class="p-4 cursor-pointer font-semibold text-gray-600" onclick="sortTable(2)">Overall Attendance</th>
                <th class="p-4 font-semibold text-gray-600">Status</th>
                <th class="p-4 font-semibold text-gray-600">Actions</th>
              </tr>
            </thead>
            <tbody id="student-table-body">
                <tr><td colspan="5" class="p-8 text-center text-gray-500">Loading student data...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
const supabaseClient = window.supabase.createClient("https://pwgdubtbvqnmivtupbvx.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3Z2R1YnRidnFubWl2dHVwYnZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwOTUzMTAsImV4cCI6MjA3MDY3MTMxMH0.kCn6JMv0kTQrkoJ7OmaxCbwZNzewRNtuOg-35nYXYXg");

// Globals to store fetched data and avoid re-fetching
let allStudents = [];
let allLectures = [];

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(";").shift();
  return null;
}

// ====== Excel Download ======
function downloadExcel() {
  const subjectFilter = document.getElementById("subject-filter");
  const selectedSubject = subjectFilter.options[subjectFilter.selectedIndex].text;
  const header = `Attendance % (${selectedSubject})`;

  let wb = XLSX.utils.book_new();
  let ws_data = [["ID", "Student Name", header, "Status"]];

  document.querySelectorAll("#student-table-body tr").forEach(tr => {
    if (tr.style.display !== 'none') {
        let cols = tr.querySelectorAll("td");
        ws_data.push([cols[0].innerText, cols[1].innerText, cols[2].innerText, cols[3].innerText]);
    }
  });
  let ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "Student Records");
  XLSX.writeFile(wb, `student_records_${selectedSubject.replace(/\s+/g, '_')}.xlsx`);
}

// ====== Search Filter ======
document.getElementById("search-box").addEventListener("input", e => {
  let filter = e.target.value.toLowerCase();
  document.querySelectorAll("#student-table-body tr").forEach(tr => {
    let text = tr.innerText.toLowerCase();
    tr.style.display = text.includes(filter) ? "" : "none";
  });
});

// ====== Sort Table ======
let sortDirection = {};
function sortTable(colIndex) {
  const tbody = document.getElementById("student-table-body");
  let rows = Array.from(tbody.querySelectorAll("tr"));
  
  sortDirection[colIndex] = !sortDirection[colIndex];

  rows.sort((a, b) => {
    let A = a.cells[colIndex].innerText;
    let B = b.cells[colIndex].innerText;
    
    if (colIndex === 2) { 
        A = parseInt(A) || 0; 
        B = parseInt(B) || 0;
    }
    
    if (A < B) return sortDirection[colIndex] ? -1 : 1;
    if (A > B) return sortDirection[colIndex] ? 1 : -1;
    return 0;
  });
  
  rows.forEach(r => tbody.appendChild(r));
}

// ====== Core function to render the student table based on subject filter ======
function renderStudentTable(selectedSubject = 'All') {
    const tableBody = document.getElementById("student-table-body");
    tableBody.innerHTML = "";
    
    // Update table header based on filter
    document.getElementById("attendance-header").textContent = selectedSubject === 'All' ? 'Overall Attendance' : `${selectedSubject} Attendance`;

    // Filter lectures if a specific subject is selected
    const relevantLectures = selectedSubject === 'All' 
        ? allLectures 
        : allLectures.filter(l => l.LECTURE === selectedSubject);
    
    const totalLecturesCount = relevantLectures.length;

    if (allStudents.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-500">No students found.</td></tr>`;
        return;
    }
    
    if (totalLecturesCount === 0 && selectedSubject !== 'All') {
        tableBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-500">No lectures found for '${selectedSubject}'.</td></tr>`;
        return;
    }
    
    allStudents.forEach(student => {
        // Count how many of the relevant lectures the student attended
        const attendedCount = relevantLectures.filter(l => l.attendees && l.attendees.includes(student.id.toString())).length;
        
        const percentage = totalLecturesCount > 0 ? Math.round((attendedCount / totalLecturesCount) * 100) : 0;

        const status = percentage >= 75 ? "Safe" : percentage >= 50 ? "Warning" : "Danger";
        const badgeClass = status === "Safe" ? "badge-safe" : status === "Warning" ? "badge-warning" : "badge-danger";
        
        const rowHTML = `
            <tr class="border-b last:border-b-0 hover:bg-gray-50 transition-colors">
                <td class="p-4 text-sm text-gray-700">${student.id}</td>
                <td class="p-4 font-medium text-gray-900">${student.name}</td>
                <td class="p-4 font-medium">${percentage}%</td>
                <td class="p-4"><span class="px-3 py-1 text-xs font-medium rounded-full ${badgeClass}">${status}</span></td>
                <td class="p-4"><a href="studentprofile.html?id=${student.id}&course=${getCookie('course')}" class="text-indigo-600 hover:underline text-sm font-medium">View Details</a></td>
            </tr>`;
        tableBody.insertAdjacentHTML("beforeend", rowHTML);
    });
}


// ====== Function to populate the subject filter dropdown ======
function populateSubjectFilter(lectures) {
    const subjectFilter = document.getElementById('subject-filter');
    const subjects = [...new Set(lectures.map(l => l.LECTURE))].sort(); // Get unique, sorted subjects
    
    subjects.forEach(subject => {
        const option = document.createElement('option');
        option.value = subject;
        option.textContent = subject;
        subjectFilter.appendChild(option);
    });
}


// ====== Page Initialization ======
document.addEventListener("DOMContentLoaded", async () => {
    // Basic page setup (date, prof name, etc.)
    document.getElementById("current-date").textContent = new Date().toLocaleDateString("en-GB", { weekday:"long", year:"numeric", month:"long", day:"numeric" });

    const profName = getCookie("name");
    if (profName) {
        const decodedName = decodeURIComponent(profName.replace(/\+/g, ' '));
        document.getElementById('prof-name').textContent = `Prof. ${decodedName}`;
        document.getElementById('prof-initial').textContent = decodedName.charAt(0).toUpperCase();
    } else {
        document.getElementById('prof-name').textContent = 'Prof. Guest';
        document.getElementById('prof-initial').textContent = 'G';
    }
    
    document.getElementById('logout-btn').addEventListener('click', (e) => {
        e.preventDefault();
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i];
            const eqPos = cookie.indexOf("=");
            const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
            document.cookie = name.trim() + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
        }
        window.location.href = "adminlogin.html";
    });

    const course = getCookie("course");
    if (!course) {
        window.location.href = "adminlogin.html";
        return;
    }
    
    document.getElementById("page-title").textContent = `${course.toUpperCase().replace('_', ' ')} Student Records`;

    // Fetch all necessary data from Supabase
    const studentsTable = `${course}_students`;
    const lecturesTable = `${course}_lectures`;

    const { data: students, error: studentsError } = await supabaseClient.from(studentsTable).select("id,name");
    const { data: lectures, error: lecturesError } = await supabaseClient.from(lecturesTable).select("LECTURE,attendees");

    if (studentsError || lecturesError) {
        console.error("Error fetching data:", studentsError || lecturesError);
        document.getElementById("student-table-body").innerHTML = `<tr><td colspan="5" class="p-8 text-center text-red-600">Failed to load data. Please try again.</td></tr>`;
        return;
    }

    // Store data in global variables
    allStudents = students || [];
    allLectures = lectures || [];
    
    // Populate the filter and set up the event listener
    populateSubjectFilter(allLectures);
    document.getElementById('subject-filter').addEventListener('change', (e) => {
        renderStudentTable(e.target.value);
    });

    // Initial render of the table with "All Subjects"
    renderStudentTable('All');

    // NEW: Render icons after everything is loaded
    lucide.createIcons();
});
</script>
</body>
</html>
