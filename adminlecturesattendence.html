<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lecture Attendance - ClassCount</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide-element"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .header-gradient { background: linear-gradient(90deg, #4f46e5, #7c3aed); }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="flex min-h-screen">
  <div class="hidden md:flex flex-col w-64 bg-gray-900 text-gray-200 shadow-xl">
    <div class="flex items-center justify-center h-20 header-gradient text-white">
      <lucide-icon name="graduation-cap" class="h-8 w-8 mr-3"></lucide-icon>
      <span class="text-2xl font-bold">ClassCount</span>
    </div>
    <nav class="flex flex-col flex-grow p-4">
      <a href="dashboard.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <lucide-icon name="layout-dashboard" class="h-5 w-5 mr-3"></lucide-icon>
        <span>Dashboard</span>
      </a>
      <a href="dashboard.html#student-records-section" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <lucide-icon name="users" class="h-5 w-5 mr-3"></lucide-icon>
        <span>Students</span>
      </a>
      <a href="lectures.html" class="flex items-center px-4 py-3 mt-2 font-semibold text-white bg-indigo-600 rounded-lg shadow-md">
        <lucide-icon name="book-open" class="h-5 w-5 mr-3"></lucide-icon>
        <span>Lectures</span>
      </a>
      <a href="activities.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <lucide-icon name="puzzle" class="h-5 w-5 mr-3"></lucide-icon>
        <span>Activities</span>
      </a>
      <a href="changepassword.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <lucide-icon name="key-round" class="h-5 w-5 mr-3"></lucide-icon>
        <span>Change Password</span>
      </a>
      <a href="#" id="logout-btn" class="flex items-center px-4 py-3 mt-2 text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors duration-200">
        <lucide-icon name="log-out" class="h-5 w-5 mr-3"></lucide-icon>
        <span>Logout</span>
      </a>
    </nav>
  </div>

  <div class="flex flex-col flex-1 overflow-y-auto">
    <header class="flex items-center justify-between h-20 px-4 sm:px-8 bg-white border-b shadow-sm sticky top-0 z-10">
      <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Lecture Attendance</h1>
      <div class="flex items-center space-x-4">
        <div class="text-sm text-gray-600 text-right">
          <p id="prof-name" class="font-semibold">Prof. ...</p>
        </div>
        <div id="prof-initial" class="w-12 h-12 rounded-full bg-indigo-600 text-white flex items-center justify-center text-xl font-bold border-2 border-indigo-300">
          ?
        </div>
      </div>
    </header>

    <main class="p-4 sm:p-8">
      <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
          <div>
            <h2 id="lecture-title" class="text-2xl font-bold text-indigo-600">Loading Lecture...</h2>
            <p id="lecture-meta" class="text-gray-500 mt-1">Fetching details...</p>
          </div>
          <button id="download-btn" class="mt-4 sm:mt-0 w-full sm:w-auto px-5 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
            <lucide-icon name="download" class="h-5 w-5"></lucide-icon>
            <span>Download Attendance</span>
          </button>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-md">
        <div class="p-6 border-b">
            <h3 id="attendee-count" class="text-xl font-semibold text-gray-800">Present Students (0)</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr class="bg-gray-50">
                <th class="p-4 font-semibold text-gray-600 w-16">Sr. No.</th>
                <th class="p-4 font-semibold text-gray-600">Student Name</th>
              </tr>
            </thead>
            <tbody id="attendee-list">
              </tbody>
          </table>
        </div>
      </div>
      
       <a href="lectures.html" class="inline-block mt-6 px-5 py-2.5 bg-gray-700 text-white font-semibold rounded-lg hover:bg-gray-800 transition-colors">
        ‚Üê Back to All Lectures
      </a>

    </main>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const SUPABASE_URL = "https://pwgdubtbvqnmivtupbvx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3Z2R1YnRidnFubWl2dHVwYnZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwOTUzMTAsImV4cCI6MjA3MDY3MTMxMH0.kCn6JMv0kTQrkoJ7OmaxCbwZNzewRNtuOg-35nYXYXg";
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  // --- State ---
  let presentStudents = [];
  let lectureDetails = {};

  // --- DOM Elements ---
  const listEl = document.getElementById("attendee-list");
  const mainContent = document.querySelector("main");
  const downloadBtn = document.getElementById("download-btn");

  // --- Helper Functions ---
  function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
      lectureNo: parseInt(params.get("no"), 10),
      course: (params.get("course") || "").toLowerCase()
    };
  }
  
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

  // --- Core Functions ---
  async function loadLectureDetails() {
    const { lectureNo, course } = getUrlParams();
    if (!lectureNo || !course) {
      mainContent.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-md text-center text-red-600 font-semibold">Error: Course or lecture number not provided in URL.</div>`;
      return;
    }

    const lecturesTable = `${course}_lectures`;
    const studentsTable = `${course}_students`;

    const { data: lecture, error: lectureErr } = await supabase.from(lecturesTable).select("*").eq("NO", lectureNo).single();
    if (lectureErr || !lecture) {
      mainContent.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-md text-center text-red-600 font-semibold">Error: Could not find the specified lecture.</div>`;
      return;
    }
    
    lectureDetails = { name: lecture.LECTURE, date: lecture.DATE, time: lecture.TIME };
    document.getElementById("lecture-title").textContent = lectureDetails.name;
    document.getElementById("lecture-meta").textContent = `${lectureDetails.date} | ${lectureDetails.time}`;

    const presentIds = new Set(lecture.attendees || []);
    if (presentIds.size === 0) {
        renderAttendeeList([]);
        return;
    }

    const { data: allStudents, error: stuErr } = await supabase.from(studentsTable).select("id, name").order("name");
    if (stuErr) {
      listEl.innerHTML = `<tr><td colspan="2" class="p-4 text-center text-red-500">Error fetching student list.</td></tr>`;
      return;
    }

    presentStudents = allStudents.filter(stu => presentIds.has(stu.id.toString()));
    renderAttendeeList(presentStudents);
  }

  function renderAttendeeList(attendees) {
    listEl.innerHTML = ""; // Clear list
    document.getElementById('attendee-count').textContent = `Present Students (${attendees.length})`;

    if (attendees.length === 0) {
      listEl.innerHTML = `<tr><td colspan="2" class="p-6 text-center text-gray-500">No students were marked present for this lecture.</td></tr>`;
      downloadBtn.disabled = true;
      return;
    }

    attendees.forEach((student, index) => {
      const row = document.createElement("tr");
      row.className = "border-b last:border-0 hover:bg-gray-50";
      row.innerHTML = `
        <td class="p-4 text-gray-600">${index + 1}</td>
        <td class="p-4 font-medium text-gray-800">${student.name}</td>
      `;
      listEl.appendChild(row);
    });

    downloadBtn.disabled = false;
  }

  function downloadExcel() {
    const dataForSheet = [
        ["Lecture:", lectureDetails.name],
        ["Date:", lectureDetails.date],
        ["Time:", lectureDetails.time],
        [], // Blank row for spacing
        ["Sr. No.", "Student Name"]
    ];

    presentStudents.forEach((student, index) => {
        dataForSheet.push([index + 1, student.name]);
    });

    const worksheet = XLSX.utils.aoa_to_sheet(dataForSheet);
    
    // Set column widths
    worksheet['!cols'] = [{ wch: 15 }, { wch: 40 }];

    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Attendance");

    // Sanitize filename
    const filename = `${lectureDetails.name.replace(/[^a-z0-9]/gi, '_')}_Attendance.xlsx`;
    XLSX.writeFile(workbook, filename);
  }

  // --- Initial Load & Event Listeners ---
  window.addEventListener("DOMContentLoaded", () => {
    const profName = getCookie("name");
    if (profName) {
      const decodedName = decodeURIComponent(profName.replace(/\+/g, ' '));
      document.getElementById('prof-name').textContent = `Prof. ${decodedName}`;
      document.getElementById('prof-initial').textContent = decodedName.charAt(0).toUpperCase();
    }

    loadLectureDetails();
    downloadBtn.addEventListener("click", downloadExcel);

    // Logout Logic
    document.getElementById('logout-btn').addEventListener('click', (e) => {
      e.preventDefault();
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i];
        const eqPos = cookie.indexOf("=");
        const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
        document.cookie = name.trim() + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
      }
      window.location.href = "adminlogin.html";
    });
  });
</script>

</body>
</html>
