<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blacklist | ClassCount</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/lucide/dist/umd/lucide.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06); }
    .header-gradient { background: linear-gradient(90deg, #4f46e5, #7c3aed); }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="flex min-h-screen">
  <div class="hidden md:flex flex-col w-64 bg-gray-900 text-gray-200 shadow-xl">
    <div class="flex items-center justify-center h-20 header-gradient text-white">
      <i data-lucide="graduation-cap" class="h-8 w-8 mr-3"></i>
      <span class="text-2xl font-bold">ClassCount</span>
    </div>
    <nav class="flex flex-col flex-grow p-4">
      <a href="dashboard.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="layout-dashboard" class="h-5 w-5 mr-3"></i>
        <span>Dashboard</span>
      </a>
      <a href="students.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="users" class="h-5 w-5 mr-3"></i>
        <span>Students</span>
      </a>
      <a href="blacklist.html" class="flex items-center px-4 py-3 mt-2 font-semibold text-white bg-indigo-600 rounded-lg shadow-md">
        <i data-lucide="shield-alert" class="h-5 w-5 mr-3"></i>
        <span>Blacklist</span>
      </a>
      <a href="lectures.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="book-open" class="h-5 w-5 mr-3"></i>
        <span>Lectures</span>
      </a>
      <a href="activities.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="puzzle" class="h-5 w-5 mr-3"></i>
        <span>Activities</span>
      </a>
      <a href="changeadminpassword.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="key-round" class="h-5 w-5 mr-3"></i>
        <span>Change Password</span>
      </a>
      <a href="#" id="logout-btn" class="flex items-center px-4 py-3 mt-2 text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors duration-200">
        <i data-lucide="log-out" class="h-5 w-5 mr-3"></i>
        <span>Logout</span>
      </a>
    </nav>
  </div>

  <div class="flex flex-col flex-1 overflow-y-auto">
    <header class="flex items-center justify-between h-20 px-4 sm:px-8 bg-white border-b shadow-sm sticky top-0 z-10">
      <h1 id="page-title" class="text-xl sm:text-2xl font-bold text-gray-900">Blacklisted Students</h1>
      <div class="flex items-center space-x-4">
        <div class="text-sm text-gray-600 text-right">
          <p id="prof-name" class="font-semibold">Prof. ...</p>
        </div>
        <div id="prof-initial" class="w-12 h-12 rounded-full bg-indigo-600 text-white flex items-center justify-center text-xl font-bold border-2 border-indigo-300">?</div>
      </div>
    </header>

    <main class="p-4 sm:p-8">
      <div class="card p-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <i data-lucide="list-x" class="h-5 w-5 text-red-600"></i>
            Defaulter List
          </h2>
          <div class="flex flex-wrap items-center gap-2 w-full sm:w-auto">
            <input id="search-box" type="text" placeholder="Search by name or ID" class="px-3 py-2 border rounded-lg text-sm w-full sm:w-48 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button onclick="downloadPdf()" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 flex items-center justify-center gap-2 transition-colors">
              <i data-lucide="file-type" class="h-4 w-4"></i>
              <span>PDF Report</span>
            </button>
            <button onclick="downloadExcel()" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 flex items-center justify-center gap-2 transition-colors">
              <i data-lucide="file-spreadsheet" class="h-4 w-4"></i>
              <span>Excel</span>
            </button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table id="student-table" class="w-full text-left border-collapse">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-4 font-semibold text-gray-600">ID</th>
                <th class="p-4 font-semibold text-gray-600">Student Name</th>
                <th class="p-4 font-semibold text-gray-600">Academic Score</th>
                <th class="p-4 font-semibold text-gray-600">Actions</th>
              </tr>
            </thead>
            <tbody id="student-table-body">
              <tr><td colspan="4" class="p-8 text-center text-gray-500">Calculating scores and generating blacklist...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
const supabaseClient = window.supabase.createClient("https://pwgdubtbvqnmivtupbvx.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3Z2R1YnRidnFubWl2dHVwYnZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwOTUzMTAsImV4cCI6MjA3MDY3MTMxMH0.kCn6JMv0kTQrkoJ7OmaxCbwZNzewRNtuOg-35nYXYXg");

// Global variables to hold data for downloads
let blacklistedStudentsData = [];
let totalStudentsCount = 0;

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(";").shift();
  return null;
}

document.getElementById("search-box").addEventListener("input", e => {
  let filter = e.target.value.toLowerCase();
  document.querySelectorAll("#student-table-body tr").forEach(tr => {
    let text = tr.innerText.toLowerCase();
    tr.style.display = text.includes(filter) ? "" : "none";
  });
});

// --- Download Functions ---
function downloadExcel() {
    if (blacklistedStudentsData.length === 0) {
        alert("No data to export.");
        return;
    }
    const course = getCookie("course") || "class";
    const ws_data = [
        ["ID", "Student Name", "Academic Score"],
        ...blacklistedStudentsData.map(s => [s.id, s.name, s.score])
    ];
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Blacklist");
    XLSX.writeFile(wb, `blacklist_report_${course}.xlsx`);
}

function downloadPdf() {
    if (blacklistedStudentsData.length === 0) {
        alert("No data to export.");
        return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const course = (getCookie("course") || "class").toUpperCase();
    const date = new Date().toLocaleDateString("en-GB");

    // Title
    doc.setFont("helvetica", "bold");
    doc.setFontSize(20);
    doc.text("ClassCount Defaulter Report", 105, 20, { align: "center" });

    // Sub-header Info
    doc.setFont("helvetica", "normal");
    doc.setFontSize(12);
    doc.text(`Class: ${course}`, 14, 35);
    doc.text(`Date: ${date}`, 14, 42);
    doc.text(`Total Students: ${totalStudentsCount}`, 14, 49);
    doc.text(`Blacklisted Students: ${blacklistedStudentsData.length}`, 14, 56);

    // Table
    doc.autoTable({
        head: [['ID', 'Student Name', 'Academic Score']],
        body: blacklistedStudentsData.map(s => [s.id, s.name, `${s.score} / 100`]),
        startY: 65,
        theme: 'grid',
        headStyles: { fillColor: [79, 70, 229] }, // Indigo color
    });
    
    // Footer
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(10);
        doc.text(`Page ${i} of ${pageCount}`, 105, 285, { align: "center" });
    }

    doc.save(`blacklist_report_${course}.pdf`);
}


async function renderBlacklistTable() {
  const tableBody = document.getElementById("student-table-body");
  const course = getCookie("course");

  if (!course) {
    window.location.href = "adminlogin.html";
    return;
  }

  try {
    const [studentsRes, lecturesRes, eventsRes] = await Promise.all([
      supabaseClient.from(`${course}_students`).select("id, name, roles"),
      supabaseClient.from(`${course}_lectures`).select("attendees"),
      supabaseClient.from(`${course}_events`).select("attendees")
    ]);

    if (studentsRes.error || lecturesRes.error || eventsRes.error) {
        throw new Error(studentsRes.error?.message || lecturesRes.error?.message || eventsRes.error?.message);
    }

    const allStudents = studentsRes.data || [];
    const allLectures = lecturesRes.data || [];
    const allEvents = eventsRes.data || [];
    
    // Assign to global variables for download functions
    totalStudentsCount = allStudents.length;
    const localBlacklist = [];

    for (const student of allStudents) {
      const studentId = student.id.toString();

      const attendedLecturesCount = allLectures.filter(l => l.attendees?.includes(studentId)).length;
      const attendancePercent = allLectures.length > 0 ? (attendedLecturesCount / allLectures.length) * 100 : 0;
      
      const attendedActivitiesCount = allEvents.filter(e => e.attendees?.includes(studentId)).length;
      const validTags = student.roles ? student.roles.filter(tag => tag && tag.toLowerCase() !== 'no tags') : [];
      
      const attendanceScore = attendancePercent * 0.5;
      const tagsBonus = validTags.length * 5;
      const eventBonus = attendedActivitiesCount * 2;
      const totalScore = Math.min(100, Math.round(attendanceScore + tagsBonus + eventBonus));

      // CORRECTED LOGIC: Only blacklist if score is LESS THAN 35
      if (totalScore < 35) {
        localBlacklist.push({ ...student, score: totalScore });
      }
    }
    
    localBlacklist.sort((a, b) => a.score - b.score);
    blacklistedStudentsData = localBlacklist; // Update global data

    tableBody.innerHTML = "";
    if (blacklistedStudentsData.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-500">ðŸŽ‰ No students are currently blacklisted.</td></tr>`;
      return;
    }

    blacklistedStudentsData.forEach(student => {
      const rowHTML = `
        <tr class="border-b last:border-b-0 hover:bg-gray-50 transition-colors">
          <td class="p-4 text-sm text-gray-700">${student.id}</td>
          <td class="p-4 font-medium text-gray-900">${student.name}</td>
          <td class="p-4 font-bold text-red-600">${student.score} / 100</td>
          <td class="p-4"><a href="studentprofile.html?id=${student.id}&course=${course}" class="text-indigo-600 hover:underline text-sm font-medium">View Details</a></td>
        </tr>`;
      tableBody.insertAdjacentHTML("beforeend", rowHTML);
    });

  } catch (error) {
    console.error("Error generating blacklist:", error);
    tableBody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-red-600">Failed to load blacklist. ${error.message}</td></tr>`;
  }
}

// ====== Page Initialization ======
document.addEventListener("DOMContentLoaded", () => {
  const profName = getCookie("name");
  if (profName) {
    const decodedName = decodeURIComponent(profName.replace(/\+/g, ' '));
    document.getElementById('prof-name').textContent = `Prof. ${decodedName}`;
    document.getElementById('prof-initial').textContent = decodedName.charAt(0).toUpperCase();
  }
  
  document.getElementById('logout-btn').addEventListener('click', (e) => {
    e.preventDefault();
    document.cookie.split(";").forEach(c => { document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); });
    window.location.href = "adminlogin.html";
  });

  renderBlacklistTable();
  lucide.createIcons();
});
</script>
</body>
</html>
