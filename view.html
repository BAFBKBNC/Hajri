<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>View Attendance - ClassCount</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; margin:0; background:#f4f6fa; color:#333; }
  header {
    background: #243b8f;
    color: #fff;
    padding: 1rem;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,.15);
  }
  header h1 { font-size: 1.4rem; margin: 0; }

  main { padding:1rem; max-width:800px; margin:auto; background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.05); }
  
  .lecture-info {
    padding: 0.8rem 1rem;
    background: #eef2ff;
    border: 1px solid #d0d7ff;
    border-radius: 8px;
    margin-bottom: 1rem;
  }
  .lecture-info h2 { margin: 0; font-size: 1.2rem; color: #243b8f; }
  .lecture-info p { margin: 0.2rem 0 0; font-size: 0.95rem; color: #555; }

  .student-list { border:1px solid #ccc; border-radius:8px; overflow: hidden; }
  .student-item {
    display:flex; justify-content:space-between; align-items:center;
    padding:0.7rem 0.9rem; border-bottom:1px solid #f0f0f0;
  }
  .student-item:last-child { border-bottom:none; }
  .student-name { font-weight:500; color:#333; }
  .badge {
    font-size:0.8rem; padding:0.25rem 0.6rem; border-radius:999px;
  }
  .badge-present { background:#e6f8e9; color:#2e7d32; border:1px solid #a5d6a7; }
  .badge-absent { background:#ffebee; color:#c62828; border:1px solid #ef9a9a; }

  .back-btn {
    display:inline-block; margin-top:1rem;
    background:#243b8f; color:white; padding:0.6rem 1.2rem;
    border-radius:6px; text-decoration:none; font-weight:600;
  }
  .back-btn:hover { background:#1b2e6d; }
</style>
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://pwgdubtbvqnmivtupbvx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3Z2R1YnRidnFubWl2dHVwYnZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwOTUzMTAsImV4cCI6MjA3MDY3MTMxMH0.kCn6JMv0kTQrkoJ7OmaxCbwZNzewRNtuOg-35nYXYXg";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const params = new URLSearchParams(window.location.search);
const lectureNo = params.get("no");

async function loadAttendance() {
  if (!lectureNo) {
    document.querySelector("main").innerHTML = "<p>No lecture number provided.</p>";
    return;
  }

  // 1. Get lecture details
  const { data: lectures, error: lecErr } = await supabase
    .from("lectures")
    .select("*")
    .eq("NO", lectureNo)
    .single();
  if (lecErr || !lectures) {
    document.querySelector("main").innerHTML = "<p>Lecture not found.</p>";
    return;
  }

  const ids = lectures.IDS && lectures.IDS !== "EMPTY"
    ? lectures.IDS.split(",").map(id => Number(id))
    : [];

  // 2. Get all students
  const { data: students, error: stuErr } = await supabase
    .from("students")
    .select("id, name")
    .order("name");
  if (stuErr) {
    console.error(stuErr);
    return;
  }

  // 3. Render
  document.getElementById("lecture-title").textContent = lectures.LECTURE;
  document.getElementById("lecture-meta").textContent = `${lectures.DATE} | ${lectures.TIME}`;
  
  const listEl = document.getElementById("student-list");
  listEl.innerHTML = "";

  students.forEach(stu => {
    const item = document.createElement("div");
    item.className = "student-item";

    const nameEl = document.createElement("span");
    nameEl.className = "student-name";
    nameEl.textContent = stu.name;

    const badge = document.createElement("span");
    if (ids.includes(stu.id)) {
      badge.className = "badge badge-present";
      badge.textContent = "Present";
    } else {
      badge.className = "badge badge-absent";
      badge.textContent = "Absent";
    }

    item.appendChild(nameEl);
    item.appendChild(badge);
    listEl.appendChild(item);
  });
}

window.addEventListener("DOMContentLoaded", loadAttendance);
</script>
</head>
<body>
<header><h1>ClassCount</h1></header>

<main>
  <div class="lecture-info">
    <h2 id="lecture-title">Loading...</h2>
    <p id="lecture-meta"></p>
  </div>
  <div id="student-list" class="student-list"></div>
  <a href="Home.html" class="back-btn">‚Üê Back</a>
</main>

</body>
</html>
