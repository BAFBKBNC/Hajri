<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>View Attendance - ClassCount</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; margin:0; background:#f4f6fa; color:#333; }
  header {
    background: #243b8f;
    color: #fff;
    padding: 1rem;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,.15);
  }
  header h1 { font-size: 1.4rem; margin: 0; }
  main { padding:1rem; max-width:800px; margin:auto; background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.05); }
  .lecture-info {
    padding: 0.8rem 1rem;
    background: #eef2ff;
    border: 1px solid #d0d7ff;
    border-radius: 8px;
    margin-bottom: 1rem;
  }
  .lecture-info h2 { margin: 0; font-size: 1.2rem; color: #243b8f; }
  .lecture-info p { margin: 0.2rem 0 0; font-size: 0.95rem; color: #555; }
  .filter-controls {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    padding: 0.5rem;
    background-color: #f1f1f1;
    border-radius: 8px;
  }
  .filter-btn {
    flex-grow: 1;
    padding: 0.6rem;
    border: 1px solid #ccc;
    background-color: #fff;
    color: #333;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
  }
  .filter-btn:hover { background-color: #e9e9e9; }
  .filter-btn.active {
    background-color: #243b8f;
    color: white;
    border-color: #243b8f;
  }
  .student-list { border:1px solid #ccc; border-radius:8px; overflow: hidden; }
  .student-item {
    display:flex; justify-content:space-between; align-items:center;
    padding:0.7rem 0.9rem; border-bottom:1px solid #f0f0f0;
  }
  .student-item:last-child { border-bottom:none; }
  .student-name { font-weight:500; color:#333; }
  .status-toggle {
    font-size:0.8rem;
    padding:0.4rem 0.8rem;
    border-radius:999px;
    border: 1px solid transparent;
    cursor: pointer;
    font-weight: 600;
    min-width: 80px;
    text-align: center;
    transition: all 0.2s ease;
  }
  .status-toggle.present { background:#e6f8e9; color:#2e7d32; border-color:#a5d6a7; }
  .status-toggle.present:hover { background: #c8e6c9; }
  .status-toggle.absent { background:#ffebee; color:#c62828; border-color:#ef9a9a; }
  .status-toggle.absent:hover { background: #ffcdd2; }
  .status-toggle:disabled { cursor: not-allowed; opacity: 0.6; }
  .back-btn {
    display:inline-block; margin-top:1rem;
    background:#243b8f; color:white; padding:0.6rem 1.2rem;
    border-radius:6px; text-decoration:none; font-weight:600;
  }
</style>
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://pwgdubtbvqnmivtupbvx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJI" + "UzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3Z2R1YnRidnFubWl2dHVwYnZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwOTUzMTAsImV4cCI6MjA3MDY3MTMxMH0.kCn6JMv0kTQrkoJ7OmaxCbwZNzewRNtuOg-35nYXYXg";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const params = new URLSearchParams(window.location.search);
const course = params.get("course"); // e.g. fybaf, sybaf
const lectureNo = parseInt(params.get("no"), 10);

if (!course) {
  document.querySelector("main").innerHTML = "<p>No course provided.</p>";
  throw new Error("Course query param is required");
}

const lecturesTable = `${course}_lectures`;
const studentsTable = `${course}_students`;

let allStudents = [];
let currentFilter = 'all';
const listEl = document.getElementById("student-list");
const filterControls = document.querySelector(".filter-controls");

async function loadAttendance() {
  if (!lectureNo) {
    document.querySelector("main").innerHTML = "<p>No lecture number provided.</p>";
    return;
  }

  const { data: lecture, error: lecErr } = await supabase
    .from(lecturesTable)
    .select("*")
    .eq("NO", lectureNo)
    .single();

  if (lecErr || !lecture) {
    document.querySelector("main").innerHTML = "<p>Lecture not found.</p>";
    console.error(lecErr);
    return;
  }

  const presentIds = lecture.IDS && lecture.IDS !== "EMPTY"
    ? lecture.IDS.split(",").map(id => Number(id))
    : [];

  const { data: students, error: stuErr } = await supabase
    .from(studentsTable)
    .select("id, name")
    .order("name");

  if (stuErr) {
    console.error(stuErr);
    return;
  }

  document.getElementById("lecture-title").textContent = lecture.LECTURE;
  document.getElementById("lecture-meta").textContent = `${lecture.DATE} | ${lecture.TIME}`;

  allStudents = students.map(stu => ({
    id: stu.id,
    name: stu.name,
    isPresent: presentIds.includes(stu.id)
  }));

  renderList();
}

function renderList() {
  listEl.innerHTML = "";
  const filteredStudents = allStudents.filter(stu => {
    if (currentFilter === 'present') return stu.isPresent;
    if (currentFilter === 'absent') return !stu.isPresent;
    return true;
  });

  if (filteredStudents.length === 0) {
    listEl.innerHTML = `<div class="student-item" style="justify-content:center;"><p>No students match this filter.</p></div>`;
    return;
  }

  filteredStudents.forEach(stu => {
    const item = document.createElement("div");
    item.className = "student-item";
    item.innerHTML = `
      <span class="student-name">${stu.name}</span>
      <button 
        class="status-toggle ${stu.isPresent ? 'present' : 'absent'}" 
        data-id="${stu.id}"
      >
        ${stu.isPresent ? 'Present' : 'Absent'}
      </button>
    `;
    listEl.appendChild(item);
  });
}

async function toggleAttendance(studentId, button) {
  button.disabled = true;
  button.textContent = 'Saving...';

  const student = allStudents.find(s => s.id === studentId);
  if (!student) return;

  const newStatus = !student.isPresent;
  const rpcName = newStatus ? 'mark_student_present' : 'mark_student_absent';

  const { error } = await supabase.rpc(rpcName, {
    p_student_id: studentId,
    p_lecture_no: lectureNo,
    p_course: course
  });

  if (error) {
    alert(`Error updating status: ${error.message}`);
    button.textContent = student.isPresent ? 'Present' : 'Absent';
  } else {
    student.isPresent = newStatus;
  }

  button.disabled = false;
  renderList();
}

filterControls.addEventListener('click', (e) => {
  if (e.target.tagName === 'BUTTON') {
    document.querySelector('.filter-btn.active').classList.remove('active');
    e.target.classList.add('active');
    currentFilter = e.target.dataset.filter;
    renderList();
  }
});

listEl.addEventListener('click', (e) => {
  if (e.target.classList.contains('status-toggle')) {
    const studentId = parseInt(e.target.dataset.id, 10);
    toggleAttendance(studentId, e.target);
  }
});

window.addEventListener("DOMContentLoaded", loadAttendance);
</script>
</head>
<body>
<header><h1>ClassCount</h1></header>
<main>
  <div class="lecture-info">
    <h2 id="lecture-title">Loading...</h2>
    <p id="lecture-meta"></p>
  </div>
  <div class="filter-controls">
    <button class="filter-btn active" data-filter="all">All</button>
    <button class="filter-btn" data-filter="present">Present</button>
    <button class="filter-btn" data-filter="absent">Absent</button>
  </div>
  <div id="student-list" class="student-list"></div>
  <a href="Home.html" class="back-btn">‚Üê Back</a>
</main>
</body>
</html>
