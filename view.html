<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>View Attendance - ClassCount Pro</title>
<style>
  :root {
    --primary-color: #4f46e5;
    --primary-hover: #4338ca;
    --secondary-color: #10b981;
    --danger-color: #ef4444;
    --light-gray: #f3f4f6;
    --medium-gray: #d1d5db;
    --dark-gray: #374151;
    --text-color: #1f2937;
    --white: #ffffff;
    --font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    --border-radius: 0.5rem;
    --box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  }

  body {
    font-family: var(--font-family);
    margin: 0;
    background-color: var(--light-gray);
    color: var(--text-color);
  }

  header {
    background: var(--white);
    padding: 1rem 2rem;
    text-align: center;
    border-bottom: 1px solid var(--medium-gray);
    box-shadow: var(--box-shadow);
  }

  header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0;
    color: var(--primary-color);
  }

  main {
    padding: 2rem 1rem;
    max-width: 900px;
    margin: 0 auto;
  }
  
  .container {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 2rem;
    box-shadow: var(--box-shadow);
  }

  .lecture-info {
    border-bottom: 1px solid var(--light-gray);
    padding-bottom: 1.5rem;
    margin-bottom: 1.5rem;
  }
  .lecture-info h2 { margin: 0; font-size: 1.5rem; color: var(--primary-color); }
  .lecture-info p { margin: 0.25rem 0 0; font-size: 1rem; color: #6b7280; }
  
  .filter-controls {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    background-color: var(--light-gray);
    border-radius: var(--border-radius);
    padding: 0.5rem;
  }
  .filter-btn {
    flex-grow: 1;
    padding: 0.75rem;
    border: none;
    background-color: transparent;
    color: var(--dark-gray);
    border-radius: 0.375rem;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }
  .filter-btn:hover { background-color: rgba(0,0,0,0.05); }
  .filter-btn.active {
    background-color: var(--white);
    color: var(--primary-color);
    box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
  }

  .student-list {
    border: 1px solid var(--medium-gray);
    border-radius: var(--border-radius);
    overflow: hidden;
  }
  .student-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.8rem 1rem;
    border-bottom: 1px solid var(--light-gray);
  }
  .student-item:last-child { border-bottom: none; }
  .student-name { font-weight: 500; color: var(--text-color); }

  .status-toggle {
    font-size: 0.8rem;
    padding: 0.4rem 1rem;
    border-radius: 999px;
    border: 1px solid transparent;
    cursor: pointer;
    font-weight: 600;
    min-width: 90px;
    text-align: center;
    transition: all 0.2s ease;
  }
  .status-toggle.present { background-color: #e0f2f1; color: #00796b; border-color: #b2dfdb; }
  .status-toggle.present:hover { background-color: #b2dfdb; }
  .status-toggle.absent { background-color: #ffebee; color: #c62828; border-color: #ffcdd2; }
  .status-toggle.absent:hover { background-color: #ffcdd2; }
  .status-toggle:disabled { cursor: not-allowed; opacity: 0.6; }

  .back-btn {
    display: inline-block;
    margin-top: 1.5rem;
    background: var(--dark-gray);
    color: white;
    padding: 0.7rem 1.5rem;
    border-radius: var(--border-radius);
    text-decoration: none;
    font-weight: 600;
    transition: background-color 0.2s;
  }
  .back-btn:hover { background-color: #4b5563; }
  
  /* Toast Notification */
  .toast {
    position: fixed;
    bottom: -100px;
    left: 50%;
    transform: translateX(-50%);
    padding: 1rem 2rem;
    border-radius: var(--border-radius);
    color: var(--white);
    font-weight: 600;
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    transition: bottom 0.5s ease-in-out;
    z-index: 1000;
  }
  .toast.show { bottom: 20px; }
  .toast.success { background-color: var(--secondary-color); }
  .toast.error { background-color: var(--danger-color); }
</style>
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/supabase-js@2/+esm";

  const SUPABASE_URL = "https://pwgdubtbvqnmivtupbvx.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3Z2R1YnRidnFubWl2dHVwYnZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwOTUzMTAsImV4cCI6MjA3MDY3MTMxMH0.kCn6JMv0kTQrkoJ7OmaxCbwZNzewRNtuOg-35nYXYXg";
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  /* --- Helpers --- */
  function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
      lectureNo: parseInt(params.get("no"), 10),
      course: (params.get("course") || "sybaf").toLowerCase()
    };
  }

  function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 500);
      }, 3000);
  }

  /* --- State --- */
  const { lectureNo, course } = getUrlParams();
  let allStudents = [];
  let currentFilter = 'all';

  /* --- DOM Elements --- */
  const listEl = document.getElementById("student-list");
  const filterControls = document.querySelector(".filter-controls");
  const mainContent = document.querySelector("main");
  const allCountEl = document.getElementById("all-count");
  const presentCountEl = document.getElementById("present-count");
  const absentCountEl = document.getElementById("absent-count");

  /* --- Core Functions --- */
  async function loadAttendance() {
    if (!lectureNo || !course) {
      mainContent.innerHTML = "<h2>Error</h2><p>Course or lecture number not provided in URL.</p>";
      return;
    }

    const lecturesTable = `${course}_lectures`;
    const studentsTable = `${course}_students`;

    const { data: lecture, error: lecErr } = await supabase.from(lecturesTable).select("*").eq("NO", lectureNo).single();
    if (lecErr || !lecture) {
      mainContent.innerHTML = "<h2>Error</h2><p>Could not find the specified lecture.</p>";
      console.error("Lecture fetch error:", lecErr);
      return;
    }

    const presentIds = new Set(lecture.attendees || []);
    
    const { data: students, error: stuErr } = await supabase.from(studentsTable).select("id, name").order("name");
    if (stuErr) {
      showToast('Error fetching student list.', 'error');
      console.error("Student fetch error:", stuErr);
      return;
    }

    document.getElementById("lecture-title").textContent = lecture.LECTURE;
    document.getElementById("lecture-meta").textContent = `${lecture.DATE} | ${lecture.TIME}`;

    allStudents = students.map(stu => ({
      id: stu.id,
      name: stu.name,
      isPresent: presentIds.has(stu.id.toString())
    }));

    renderList();
  }

  function renderList() {
    listEl.innerHTML = ""; // Clear current list

    // Update counters
    const presentCount = allStudents.filter(s => s.isPresent).length;
    const absentCount = allStudents.length - presentCount;
    allCountEl.textContent = `(${allStudents.length})`;
    presentCountEl.textContent = `(${presentCount})`;
    absentCountEl.textContent = `(${absentCount})`;
    
    const filteredStudents = allStudents.filter(stu => {
      if (currentFilter === 'present') return stu.isPresent;
      if (currentFilter === 'absent') return !stu.isPresent;
      return true; // 'all'
    });

    if (filteredStudents.length === 0) {
      listEl.innerHTML = `<div class="student-item" style="justify-content:center; color:#6b7280;">No students in this category.</div>`;
      return;
    }

    filteredStudents.forEach(stu => {
      const item = document.createElement("div");
      item.className = "student-item";
      item.innerHTML = `
        <span class="student-name">${stu.name}</span>
        <button 
          class="status-toggle ${stu.isPresent ? 'present' : 'absent'}" 
          data-id="${stu.id}"
        >
          ${stu.isPresent ? 'Present' : 'Absent'}
        </button>
      `;
      listEl.appendChild(item);
    });
  }

  // REWRITTEN LOGIC: Simple, safe, and efficient.
  async function toggleAttendance(studentId, button) {
    button.disabled = true;
    button.textContent = '...';

    const student = allStudents.find(s => s.id === studentId);
    if (!student) return;

    const newStatus = !student.isPresent;
    
    // 1. Get the latest list of attendees to avoid conflicts
    const lecturesTable = `${course}_lectures`;
    const { data: lecture, error: fetchError } = await supabase
        .from(lecturesTable)
        .select('attendees')
        .eq('NO', lectureNo)
        .single();

    if (fetchError) {
        showToast('Could not sync with database. Please refresh.', 'error');
        button.disabled = false; // Re-enable button
        renderList(); // Revert visual state
        return;
    }

    // 2. Modify the array in JavaScript
    const attendeesSet = new Set((lecture.attendees || []).map(String));
    if (newStatus === true) { // Marking as present
        attendeesSet.add(studentId.toString());
    } else { // Marking as absent
        attendeesSet.delete(studentId.toString());
    }
    const newAttendeesArray = Array.from(attendeesSet);

    // 3. Send the entire updated array back to Supabase
    const { error: updateError } = await supabase
      .from(lecturesTable)
      .update({ attendees: newAttendeesArray })
      .eq('NO', lectureNo);
    
    if (updateError) {
      showToast(`Error: ${updateError.message}`, 'error');
    } else {
      // 4. Update local state on success
      student.isPresent = newStatus;
      showToast(`${student.name} marked as ${newStatus ? 'Present' : 'Absent'}.`, 'success');
    }
    
    button.disabled = false;
    renderList(); // Re-render the entire list to reflect changes and update counters
  }

  /* --- Event Listeners --- */
  filterControls.addEventListener('click', (e) => {
    const button = e.target.closest('.filter-btn');
    if (button) {
      document.querySelector('.filter-btn.active').classList.remove('active');
      button.classList.add('active');
      currentFilter = button.dataset.filter;
      renderList();
    }
  });

  listEl.addEventListener('click', (e) => {
    const button = e.target.closest('.status-toggle');
    if (button) {
      const studentId = parseInt(button.dataset.id, 10);
      toggleAttendance(studentId, button);
    }
  });

  window.addEventListener("DOMContentLoaded", loadAttendance);
</script>
</head>
<body>
<header><h1>ClassCount Pro</h1></header>

<main>
  <div class="container">
    <div class="lecture-info">
      <h2 id="lecture-title">Loading Lecture...</h2>
      <p id="lecture-meta">Fetching details...</p>
    </div>

    <div class="filter-controls">
      <button class="filter-btn active" data-filter="all">All <span id="all-count">(0)</span></button>
      <button class="filter-btn" data-filter="present">Present <span id="present-count">(0)</span></button>
      <button class="filter-btn" data-filter="absent">Absent <span id="absent-count">(0)</span></button>
    </div>

    <div id="student-list" class="student-list">
      </div>

    <a href="javascript:history.back()" class="back-btn">‚Üê Back</a>
  </div>
</main>
</body>
</html>
