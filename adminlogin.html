<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - ClassCount</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide-element"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .header-gradient { background: linear-gradient(90deg, #4f46e5, #7c3aed); }
    /* Style for disabled button */
    button:disabled {
        cursor: not-allowed;
        background-color: #a5b4fc; /* Lighter indigo */
    }
  </style>
</head>
<body class="bg-gray-100">

<div class="flex items-center justify-center min-h-screen px-4">
  <div class="w-full max-w-md">
    <div class="bg-white rounded-xl shadow-2xl overflow-hidden">
      
      <div class="flex flex-col items-center justify-center p-8 header-gradient text-white">
        <lucide-icon name="graduation-cap" class="h-12 w-12 mb-2"></lucide-icon>
        <h1 class="text-3xl font-bold">ClassCount</h1>
        <p class="text-indigo-200 mt-1">Admin Portal Login</p>
      </div>

      <form id="login-form" class="p-8 space-y-6">
        
        <div>
          <label for="admin-id" class="text-sm font-medium text-gray-700">Admin ID</label>
          <div class="mt-1 relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <lucide-icon name="user-circle" class="h-5 w-5 text-gray-400"></lucide-icon>
            </div>
            <input 
              id="admin-id" 
              name="admin-id" 
              type="text" 
              autocomplete="username" 
              required 
              placeholder="Enter your Admin ID"
              class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
          </div>
        </div>

        <div>
          <label for="password" class="text-sm font-medium text-gray-700">Password</label>
          <div class="mt-1 relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <lucide-icon name="lock" class="h-5 w-5 text-gray-400"></lucide-icon>
            </div>
            <input 
              id="password" 
              name="password" 
              type="password" 
              autocomplete="current-password" 
              required 
              placeholder="••••••••"
              class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
          </div>
        </div>
        
        <div>
          <button id="submit-button" type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
            Sign in
          </button>
        </div>

      </form>
    </div>

    <p class="mt-6 text-center text-sm text-gray-500">
        Need to change your password? <a href="changepassword.html" class="font-medium text-indigo-600 hover:text-indigo-500">Change Password</a>
    </p>

  </div>
</div>

<script>
    // Initialize Supabase Client
    const supabaseUrl = "https://pwgdubtbvqnmivtupbvx.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3Z2R1YnRidnFubWl2dHVwYnZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwOTUzMTAsImV4cCI6MjA3MDY3MTMxMH0.kCn6JMv0kTQrkoJ7OmaxCbwZNzewRNtuOg-35nYXYXg";
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    /**
     * Sets a cookie with a name, value, and expiration time in hours.
     * @param {string} name The name of the cookie.
     * @param {string} value The value of the cookie.
     * @param {number} hours The number of hours until the cookie expires.
     */
    function setCookie(name, value, hours) {
        let expires = "";
        if (hours) {
            const date = new Date();
            date.setTime(date.getTime() + (hours * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    const loginForm = document.getElementById('login-form');
    const submitButton = document.getElementById('submit-button');

    loginForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        submitButton.disabled = true;
        submitButton.textContent = 'Signing in...';

        const adminId = document.getElementById('admin-id').value;
        const password = document.getElementById('password').value;

        try {
            const { data, error } = await supabaseClient.rpc('login_admin', {
                p_admin_id: adminId,
                p_password: password
            });

            if (error) {
                throw new Error("An error occurred during login. Please try again.");
            }

            if (data) {
                alert('Login Successful! Redirecting...');

                setCookie('id', data.id, 1);
                setCookie('name', data.Name, 1);
                // UPDATED: Use the course from the database
                setCookie('course', data.course, 1); 

                window.location.href = 'index.html';

            } else {
                throw new Error("Invalid ID or password.");
            }

        } catch (error) {
            alert(`Login Failed: ${error.message}`);
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Sign in';
        }
    });
</script>

</body>
</html>
