<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Attendance Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8fafc;
    }

    .progress-ring__circle {
      transition: stroke-dashoffset 0.6s ease-out;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }
  </style>
</head>

<body class="antialiased text-gray-800">

  <div class="min-h-screen max-w-lg mx-auto bg-white shadow-lg relative">

    <!-- QR Logo Button -->
    <a href="QR.html" aria-label="View QR Code" class="absolute top-4 right-4 md:right-6 z-20">
      <div
        class="p-1 bg-white rounded-full shadow-md border border-gray-200 hover:scale-105 transition-transform duration-200">
        <img src="https://i.ibb.co/KcNr22wJ/C-2.png" alt="QR Code" class="w-12 h-12 object-contain">
      </div>
    </a>

    <header
      class="bg-indigo-600 text-white p-4 flex justify-between items-center rounded-b-2xl sticky top-0 z-10 shadow-md">
      <div>
        <p class="text-sm opacity-80">Welcome back,</p>
        <h1 id="studentName" class="text-2xl font-bold">Loading...</h1>
      </div>
    </header>

    <main class="p-4 md:p-6 space-y-8">

      <section class="bg-gray-50 p-6 rounded-2xl shadow-sm border border-gray-200">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Overall Attendance</h2>
        <div class="flex items-center justify-center space-x-6">
          <div class="relative w-32 h-32">
            <svg class="w-full h-full" viewBox="0 0 100 100">
              <circle class="text-gray-200" stroke-width="10" stroke="currentColor" fill="transparent" r="45" cx="50"
                cy="50" />
              <circle id="progress-circle" class="progress-ring__circle" stroke-width="10" stroke-linecap="round"
                stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
            </svg>
            <div class="absolute inset-0 flex flex-col items-center justify-center">
              <span id="attendancePercent" class="text-3xl font-bold text-indigo-600">--%</span>
            </div>
          </div>
          <div class="text-left">
            <p id="attendanceStatusText" class="text-2xl font-bold">--</p>
            <p class="text-sm text-gray-500 mt-1">Minimum 75% required.</p>
            <p id="missedClasses" class="text-sm text-gray-500">-- classes missed so far.</p>
          </div>
        </div>
      </section>

      <section>
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Recently Attended</h2>
        <div id="lecturesList" class="space-y-3">
          <div class="text-center text-gray-500 p-4">Loading recent lectures...</div>
        </div>
      </section>

      <section>
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Subject Breakdown</h2>
        <div id="subject-list" class="grid grid-cols-1 gap-3">
          <div class="text-center text-gray-500 p-4">Calculating subject attendance...</div>
        </div>
      </section>
    </main>

    <div class="p-4 md:p-6 pb-8 flex justify-center">
      <button id="logoutButton"
        class="w-full max-w-xs bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg transition-colors duration-200">
        <div class="flex items-center justify-center space-x-2">
          <i data-lucide="log-out" class="w-5 h-5"></i>
          <span>Log Out</span>
        </div>
      </button>
    </div>
  </div>

  <script src="https://unpkg.com/lucide-icons@latest/dist/lucide.js"></script>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://pwgdubtbvqnmivtupbvx.supabase.co';
    const SUPABASE_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3Z2R1YnRidnFubWl2dHVwYnZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwOTUzMTAsImV4cCI6MjA3MDY3MTMxMH0.kCn6JMv0kTQrkoJ7OmaxCbwZNzewRNtuOg-35nYXYXg';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function logout() {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i];
        const eqPos = cookie.indexOf("=");
        const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
        document.cookie = name.trim() + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
      }
      window.location.replace('login.html');
    }

    async function fetchProfessorMap(course) {
      const { data, error } = await supabase
        .from(`${course}_prof`)
        .select('subject, name');
      if (error) {
        console.error("Error fetching professor map:", error);
        return {};
      }
      return data.reduce((map, item) => {
        map[item.subject] = item.name;
        return map;
      }, {});
    }

    function setProgress(percent) {
      const circle = document.getElementById('progress-circle');
      if (!circle) return;
      const radius = circle.r.baseVal.value;
      const circumference = 2 * Math.PI * radius;
      const offset = circumference - (percent / 100) * circumference;

      circle.style.strokeDasharray = `${circumference} ${circumference}`;
      circle.style.strokeDashoffset = offset;
    }

    async function displayDynamicSubjectBreakdown(attendedLectureIds, course, professorMap) {
      const container = document.getElementById('subject-list');
      if (!container) return;
      container.innerHTML = `<div class="text-center text-gray-500 p-4">Calculating...</div>`;

      const { data: allLectures, error } = await supabase
        .from(`${course}_lectures`)
        .select('NO, LECTURE');

      if (error || !allLectures) {
        console.error("Error fetching all lectures:", error);
        container.innerHTML = `<div class="text-center text-red-500 p-4">Could not load subject data.</div>`;
        return;
      }

      const subjectStats = {};
      for (const lecture of allLectures) {
        const subjectName = lecture.LECTURE;
        if (!subjectStats[subjectName]) {
          subjectStats[subjectName] = { total: 0, attended: 0 };
        }
        subjectStats[subjectName].total++;
        if (attendedLectureIds.has(String(lecture.NO))) {
          subjectStats[subjectName].attended++;
        }
      }

      container.innerHTML = '';
      const sortedSubjects = Object.keys(subjectStats).sort();

      if (sortedSubjects.length === 0) {
        container.innerHTML = `<div class="text-center text-gray-500 p-4">No subject data available.</div>`;
        return;
      }

      for (const subjectName of sortedSubjects) {
        const stats = subjectStats[subjectName];
        const percentage = stats.total > 0 ? Math.round((stats.attended / stats.total) * 100) : 0;

        let textColor = 'text-green-600';
        if (percentage < 75) textColor = 'text-red-500';
        else if (percentage < 80) textColor = 'text-orange-500';

        const professor = professorMap[subjectName] || 'N/A';

        container.innerHTML += `
          <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 flex justify-between items-center">
            <div>
              <p class="font-semibold text-gray-800">${subjectName}</p>
              <p class="text-sm text-gray-500">${professor}</p>
            </div>
            <div class="text-right">
              <p class="text-lg font-bold ${textColor}">${percentage}%</p>
              <p class="text-xs text-gray-500">${stats.attended}/${stats.total}</p>
            </div>
          </div>
        `;
      }
    }

    async function loadAttendedLectures(lectureIdsString, course, professorMap) {
      const list = document.getElementById("lecturesList");
      if (!lectureIdsString) {
        list.innerHTML = `<div class="text-center text-gray-500 p-4">No lecture attendance records found.</div>`;
        return;
      }

      const lectureIds = lectureIdsString.split(',').map(id => id.trim()).filter(id => id);
      if (lectureIds.length === 0) {
        list.innerHTML = `<div class="text-center text-gray-500 p-4">No lectures attended.</div>`;
        return;
      }

      const { data: lectures, error } = await supabase
        .from(`${course}_lectures`)
        .select('DATE, TIME, LECTURE')
        .in('NO', lectureIds)
        .order('NO', { ascending: false })
        .limit(5);

      if (error || !lectures || lectures.length === 0) {
        console.error("Error fetching attended lectures:", error);
        list.innerHTML = `<div class="text-center text-gray-500 p-4">Could not load recent lectures.</div>`;
        return;
      }

      list.innerHTML = "";
      lectures.forEach(lec => {
        const professor = professorMap[lec.LECTURE] || 'N/A';
        const dateParts = lec.DATE.split('/');
        const dateObj = new Date(`${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`);
        const day = dateObj.getDate();
        const month = dateObj.toLocaleString('default', { month: 'short' }).toUpperCase();

        list.innerHTML += `
          <div class="flex items-center bg-green-50 p-4 rounded-lg">
            <div class="w-16 text-center bg-white rounded-md p-2 shadow-sm border border-gray-200">
              <p class="font-bold text-indigo-600 text-xl">${day}</p>
              <p class="text-xs font-semibold text-gray-500">${month}</p>
            </div>
            <div class="flex-1 pl-4">
              <p class="font-semibold text-gray-800">${lec.LECTURE}</p>
              <p class="text-sm text-gray-500">${professor}</p>
            </div>
            <span class="text-xs font-semibold text-green-700">${lec.TIME}</span>
          </div>
        `;
      });
    }

    async function loadDashboard() {
      const studentId = getCookie('ID');
      const course = getCookie('course');

      if (!studentId || !course) {
        document.body.innerHTML =
          `<div class="h-screen flex items-center justify-center text-center"><div><h1 class="text-2xl font-bold">Session Invalid</h1><p class="text-gray-600">Redirecting to login page...</p></div></div>`;
        setTimeout(() => {
          window.location.replace('login.html');
        }, 1500);
        return;
      }

      const professorMap = await fetchProfessorMap(course);

      const { data: student, error: studentError } = await supabase
        .from(`${course}_students`)
        .select('id, name, attended, lectures')
        .eq('id', studentId)
        .single();

      if (studentError || !student) {
        console.error("Student not found:", studentError);
        document.getElementById('studentName').textContent = "Student Not Found";
        return;
      }

      const { count: totalLectures, error: lecturesError } = await supabase
        .from(`${course}_lectures`)
        .select('*', { count: 'exact', head: true });

      if (lecturesError) {
        console.error("Error fetching total lectures:", lecturesError);
        return;
      }

      const attendancePercent = totalLectures > 0 ? Math.round((student.attended / totalLectures) * 100) : 0;
      const missedClassesCount = totalLectures - student.attended;

      document.getElementById('studentName').textContent = student.name;
      document.getElementById('attendancePercent').textContent = `${attendancePercent}%`;
      document.getElementById('missedClasses').textContent = `${missedClassesCount} classes missed so far.`;

      const statusTextElement = document.getElementById('attendanceStatusText');
      const progressCircle = document.getElementById('progress-circle');
      if (attendancePercent >= 75) {
        statusTextElement.textContent = "You're Safe!";
        statusTextElement.className = 'text-2xl font-bold text-green-600';
        progressCircle.classList.add('text-green-500');
      } else if (attendancePercent >= 60) {
        statusTextElement.textContent = 'Warning!';
        statusTextElement.className = 'text-2xl font-bold text-orange-500';
        progressCircle.classList.add('text-orange-500');
      } else {
        statusTextElement.textContent = 'Danger Zone!';
        statusTextElement.className = 'text-2xl font-bold text-red-500';
        progressCircle.classList.add('text-red-500');
      }

      setTimeout(() => setProgress(attendancePercent), 100);

      const attendedLectureIds = new Set(student.lectures ? student.lectures.split(',').map(id => id.trim()) : []);
      loadAttendedLectures(student.lectures, course, professorMap);
      displayDynamicSubjectBreakdown(attendedLectureIds, course, professorMap);
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadDashboard();
      lucide.createIcons();
      document.getElementById('logoutButton').addEventListener('click', (e) => {
        e.preventDefault();
        logout();
      });
    });
  </script>
</body>

</html>
