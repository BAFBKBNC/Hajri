<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Profile - ClassCount</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide-element"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .header-gradient { background: linear-gradient(90deg, #4f46e5, #7c3aed); }
    .progress-ring__circle {
      transition: stroke-dashoffset 0.6s ease-out;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="flex min-h-screen">
  <div class="hidden md:flex flex-col w-64 bg-gray-900 text-gray-200 shadow-xl">
    <div class="flex items-center justify-center h-20 header-gradient text-white">
      <lucide-icon name="graduation-cap" class="h-8 w-8 mr-3"></lucide-icon>
      <span class="text-2xl font-bold">ClassCount</span>
    </div>
    <nav class="flex flex-col flex-grow p-4">
      <a href="index.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <lucide-icon name="layout-dashboard" class="h-5 w-5 mr-3"></lucide-icon>
        <span>Dashboard</span>
      </a>
      <a href="index.html#student-records-section" class="flex items-center px-4 py-3 mt-2 font-semibold text-white bg-indigo-600 rounded-lg shadow-md">
        <lucide-icon name="users" class="h-5 w-5 mr-3"></lucide-icon>
        <span>Students</span>
      </a>
      <a href="lectures.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <lucide-icon name="book-open" class="h-5 w-5 mr-3"></lucide-icon>
        <span>Lectures</span>
      </a>
      <a href="activities.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <lucide-icon name="puzzle" class="h-5 w-5 mr-3"></lucide-icon>
        <span>Activities</span>
      </a>
      <a href="changepassword.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <lucide-icon name="key-round" class="h-5 w-5 mr-3"></lucide-icon>
        <span>Change Password</span>
      </a>
      <a href="#" id="logout-btn" class="flex items-center px-4 py-3 mt-2 text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors duration-200">
        <lucide-icon name="log-out" class="h-5 w-5 mr-3"></lucide-icon>
        <span>Logout</span>
      </a>
    </nav>
  </div>

  <div class="flex flex-col flex-1 overflow-y-auto">
    <header class="flex items-center justify-between h-20 px-4 sm:px-8 bg-white border-b shadow-sm sticky top-0 z-10">
      <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Student Profile</h1>
      <div class="flex items-center space-x-4">
        <div class="text-sm text-gray-600 text-right">
          <p id="prof-name" class="font-semibold">Prof. ...</p>
        </div>
        <div id="prof-initial" class="w-12 h-12 rounded-full bg-indigo-600 text-white flex items-center justify-center text-xl font-bold border-2 border-indigo-300">?</div>
      </div>
    </header>

    <main class="p-4 sm:p-8">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-2 space-y-8">
          
          <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Overall Attendance</h2>
            <div class="flex flex-col sm:flex-row items-center justify-center sm:justify-start sm:space-x-6">
              <div class="relative w-36 h-36">
                <svg class="w-full h-full" viewBox="0 0 100 100">
                  <circle class="text-gray-200" stroke-width="10" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                  <circle id="progress-circle" class="progress-ring__circle" stroke-width="10" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                  <span id="attendancePercent" class="text-3xl font-bold text-indigo-600">--%</span>
                </div>
              </div>
              <div class="text-center sm:text-left mt-4 sm:mt-0">
                <p id="attendanceStatusText" class="text-3xl font-bold">--</p>
                <p class="text-sm text-gray-500 mt-1">Minimum 75% required for good standing.</p>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-lg shadow-md">
             <div class="p-6 border-b"><h3 class="text-xl font-semibold text-gray-800">Subject-wise Attendance</h3></div>
             <div class="overflow-x-auto"><table class="w-full text-left"><tbody id="subject-attendance-list"></tbody></table></div>
          </div>

          <div class="bg-white rounded-lg shadow-md">
             <div class="p-6 border-b"><h3 class="text-xl font-semibold text-gray-800">Recently Attended Lectures</h3></div>
             <div id="recent-lectures-list" class="divide-y divide-gray-200"></div>
          </div>

          <div class="bg-white rounded-lg shadow-md">
             <div class="p-6 border-b"><h3 class="text-xl font-semibold text-gray-800">Co-curricular Activities</h3></div>
             <div id="recent-activities-list" class="divide-y divide-gray-200"></div>
          </div>

          <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Weekly Test Insights</h2>
            <div class="text-center text-gray-500 py-8">
              <lucide-icon name="bar-chart-3" class="mx-auto h-12 w-12 text-gray-400"></lucide-icon>
              <p class="mt-4 font-medium">No insights available currently.</p>
            </div>
          </div>

          <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Field Project Details</h2>
             <div id="field-project-details" class="space-y-3">
                 <div class="text-center text-gray-500 py-8">
                    <lucide-icon name="clipboard-list" class="mx-auto h-12 w-12 text-gray-400"></lucide-icon>
                    <p class="mt-4 font-medium">Project details not yet updated.</p>
                </div>
            </div>
          </div>

        </div>

        <div class="lg:col-span-1 space-y-8">

          <div class="bg-white p-6 rounded-lg shadow-md text-center">
            <img id="profile-photo" src="https://i.pravatar.cc/150" alt="Profile Photo" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-indigo-200">
            <h2 id="profile-name" class="text-2xl font-bold text-gray-900">Loading...</h2>
            <p id="profile-course-year" class="text-indigo-600 font-medium"></p>
            <div class="mt-4 pt-4 border-t border-gray-200">
              <p class="text-sm text-gray-500">Mentor</p>
              <p id="profile-mentor" class="font-semibold text-gray-700"></p>
            </div>
          </div>

          <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Roles & Tags</h2>
            <div id="roles-tags-list" class="flex flex-wrap gap-2">
              <p class="text-sm text-gray-500">No roles or tags assigned.</p>
            </div>
          </div>

        </div>
      </div>
    </main>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const SUPABASE_URL = "https://pwgdubtbvqnmivtupbvx.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3Z2R1YnRidnFubWl2dHVwYnZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwOTUzMTAsImV4cCI6MjA3MDY3MTMxMH0.kCn6JMv0kTQrkoJ7OmaxCbwZNzewRNtuOg-35nYXYXg";
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  // --- HELPER FUNCTIONS ---
  function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
      studentId: params.get("id"),
      course: params.get("course")
    };
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }
  
  function setProgress(percent) {
    const circle = document.getElementById('progress-circle');
    if (!circle) return;
    const radius = circle.r.baseVal.value;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference - (percent / 100) * circumference;
    circle.style.strokeDasharray = `${circumference} ${circumference}`;
    circle.style.strokeDashoffset = offset;
  }
  
  // --- UI UPDATE FUNCTIONS ---
  
  function displayProfileInfo(student) {
      document.getElementById('profile-photo').src = student.profile_photo_url || 'https://i.pravatar.cc/150';
      document.getElementById('profile-name').textContent = student.name || 'N/A';
      document.getElementById('profile-course-year').textContent = `${student.course || 'Course N/A'} - ${student.year || 'Year N/A'}`;
      document.getElementById('profile-mentor').textContent = student.mentor_name || 'Not Assigned';
  }

  function displayRolesAndTags(tags) {
      const container = document.getElementById('roles-tags-list');
      if (!tags || tags.length === 0) {
          container.innerHTML = `<p class="text-sm text-gray-500">No roles or tags assigned.</p>`;
          return;
      }
      container.innerHTML = '';
      tags.forEach(tag => {
          // Simple logic to assign colors based on tag content
          let colorClasses = 'bg-gray-200 text-gray-800';
          if (['NCC', 'NSS', 'Sports'].includes(tag)) colorClasses = 'bg-blue-100 text-blue-800';
          if (['Good Conduct'].includes(tag)) colorClasses = 'bg-green-100 text-green-800';
          if (['Misbehavior', 'Medically Unstable'].includes(tag)) colorClasses = 'bg-red-100 text-red-800';
          
          container.innerHTML += `<span class="px-3 py-1 text-xs font-medium rounded-full ${colorClasses}">${tag}</span>`;
      });
  }

  function displayOverallAttendance(attendedCount, totalCount) {
      const percent = totalCount > 0 ? Math.round((attendedCount / totalCount) * 100) : 0;
      document.getElementById('attendancePercent').textContent = `${percent}%`;
      
      const statusText = document.getElementById('attendanceStatusText');
      const progressCircle = document.getElementById('progress-circle');
      
      let status = "Danger Zone";
      let statusColor = 'text-red-500';
      
      if (percent >= 75) {
          status = "Good Standing";
          statusColor = 'text-green-500';
      } else if (percent >= 50) {
          status = "Needs Improvement";
          statusColor = 'text-orange-500';
      }
      
      statusText.textContent = status;
      statusText.className = `text-3xl font-bold ${statusColor}`;
      progressCircle.className = `progress-ring__circle ${statusColor}`;
      
      setTimeout(() => setProgress(percent), 100);
  }

  function displaySubjectAttendance(allLectures, attendedLectureIds) {
      const container = document.getElementById('subject-attendance-list');
      container.innerHTML = '';
      
      const subjectStats = allLectures.reduce((acc, lecture) => {
          const name = lecture.LECTURE;
          if (!acc[name]) acc[name] = { total: 0, attended: 0 };
          acc[name].total++;
          if (attendedLectureIds.has(lecture.NO)) {
              acc[name].attended++;
          }
          return acc;
      }, {});

      Object.entries(subjectStats).forEach(([subject, stats]) => {
          const percent = stats.total > 0 ? Math.round((stats.attended / stats.total) * 100) : 0;
          let color = percent >= 75 ? 'bg-green-500' : percent >= 50 ? 'bg-orange-500' : 'bg-red-500';
          
          container.innerHTML += `
              <tr class="border-b last:border-b-0">
                  <td class="p-4 font-medium text-gray-800">${subject}</td>
                  <td class="p-4 text-gray-600 text-right">${stats.attended} / ${stats.total}</td>
                  <td class="p-4 w-1/3">
                      <div class="w-full bg-gray-200 rounded-full h-2.5">
                          <div class="${color} h-2.5 rounded-full" style="width: ${percent}%"></div>
                      </div>
                  </td>
                  <td class="p-4 font-bold text-gray-800 w-20 text-right">${percent}%</td>
              </tr>
          `;
      });
  }
  
  function renderItemList(containerId, items, type) {
      const container = document.getElementById(containerId);
      if (!items || items.length === 0) {
          container.innerHTML = `<p class="p-6 text-center text-gray-500">No recent ${type} found.</p>`;
          return;
      }
      container.innerHTML = '';
      items.slice(0, 5).forEach(item => { // Show max 5 recent
          container.innerHTML += `
              <div class="flex items-center justify-between p-4 hover:bg-gray-50">
                <div>
                  <p class="font-semibold text-gray-900">${type === 'lectures' ? item.LECTURE : item.EVENTS}</p>
                  <p class="text-sm text-gray-500">${item.DATE} at ${item.TIME}</p>
                </div>
                <span class="px-3 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Attended</span>
              </div>
          `;
      });
  }

  // --- MAIN DATA LOADING FUNCTION ---
  
  async function loadStudentProfile() {
    const { studentId, course } = getUrlParams();
    if (!studentId || !course) {
        document.body.innerHTML = `<div class="h-screen w-full flex items-center justify-center text-center"><div><h1 class="text-2xl font-bold">Error</h1><p class="text-gray-600">Student ID or Course not provided in URL.</p></div></div>`;
        return;
    }
    
    // Fetch all necessary data in parallel
    const [studentRes, lecturesRes, eventsRes] = await Promise.all([
        supabase.from(`${course}_students`).select('*').eq('id', studentId).single(),
        supabase.from(`${course}_lectures`).select('NO, LECTURE, DATE, TIME, attendees'),
        supabase.from(`${course}_events`).select('NO, EVENTS, DATE, TIME, attendees')
    ]);

    // Handle Student Data
    if (studentRes.error || !studentRes.data) {
        console.error("Student not found:", studentRes.error);
        document.getElementById('profile-name').textContent = "Student Not Found";
        return;
    }
    const student = studentRes.data;
    displayProfileInfo(student);
    // Assumes roles_tags is an array column in your students table
    displayRolesAndTags(student.roles_tags);

    // Handle Lectures Data
    const allLectures = lecturesRes.data || [];
    const attendedLectures = allLectures.filter(lec => lec.attendees && lec.attendees.includes(studentId));
    const attendedLectureIds = new Set(attendedLectures.map(l => l.NO));
    
    displayOverallAttendance(attendedLectures.length, allLectures.length);
    displaySubjectAttendance(allLectures, attendedLectureIds);
    renderItemList('recent-lectures-list', attendedLectures.sort((a,b) => b.NO - a.NO), 'lectures');

    // Handle Activities/Events Data
    const allActivities = eventsRes.data || [];
    const attendedActivities = allActivities.filter(act => act.attendees && act.attendees.includes(studentId));
    renderItemList('recent-activities-list', attendedActivities.sort((a,b) => b.NO - a.NO), 'activities');
  }

  // --- INITIALIZATION ---
  
  document.addEventListener('DOMContentLoaded', () => {
    // Setup mentor profile in header
    const profName = getCookie("name");
    if (profName) {
      const decodedName = decodeURIComponent(profName.replace(/\+/g, ' '));
      document.getElementById('prof-name').textContent = `Prof. ${decodedName}`;
      document.getElementById('prof-initial').textContent = decodedName.charAt(0).toUpperCase();
    }
    
    // Logout Logic
    document.getElementById('logout-btn').addEventListener('click', (e) => {
      e.preventDefault();
      // Clear cookies and redirect
    });

    loadStudentProfile();
  });
</script>

</body>
</html>
