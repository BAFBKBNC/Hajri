<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FP List | ClassCount</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/lucide/dist/umd/lucide.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06); }
    .header-gradient { background: linear-gradient(90deg, #4f46e5, #7c3aed); }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="flex min-h-screen">
  <div class="hidden md:flex flex-col w-64 bg-gray-900 text-gray-200 shadow-xl">
    <div class="flex items-center justify-center h-20 header-gradient text-white">
      <i data-lucide="graduation-cap" class="h-8 w-8 mr-3"></i>
      <span class="text-2xl font-bold">ClassCount</span>
    </div>
    <nav class="flex flex-col flex-grow p-4">
      <a href="dashboard.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="layout-dashboard" class="h-5 w-5 mr-3"></i>
        <span>Dashboard</span>
      </a>
      <a href="students.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="users" class="h-5 w-5 mr-3"></i>
        <span>Students</span>
      </a>
      <a href="fplist.html" class="flex items-center px-4 py-3 mt-2 font-semibold text-white bg-indigo-600 rounded-lg shadow-md">
        <i data-lucide="clipboard-list" class="h-5 w-5 mr-3"></i>
        <span>FP List</span>
      </a>
      <a href="lectures.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="book-open" class="h-5 w-5 mr-3"></i>
        <span>Lectures</span>
      </a>
      <a href="activities.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="puzzle" class="h-5 w-5 mr-3"></i>
        <span>Activities</span>
      </a>
      <a href="changepassword.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <i data-lucide="key-round" class="h-5 w-5 mr-3"></i>
        <span>Change Password</span>
      </a>
      <a href="#" id="logout-btn" class="flex items-center px-4 py-3 mt-2 text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors duration-200">
        <i data-lucide="log-out" class="h-5 w-5 mr-3"></i>
        <span>Logout</span>
      </a>
    </nav>
  </div>

  <div class="flex flex-col flex-1 overflow-y-auto">
    <header class="flex items-center justify-between h-20 px-4 sm:px-8 bg-white border-b shadow-sm sticky top-0 z-10">
      <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Field Project List</h1>
      <div class="flex items-center space-x-4">
        <div class="text-sm text-gray-600 text-right">
          <p id="prof-name" class="font-semibold">Prof. ...</p>
        </div>
        <div id="prof-initial" class="w-12 h-12 rounded-full bg-indigo-600 text-white flex items-center justify-center text-xl font-bold border-2 border-indigo-300">?</div>
      </div>
    </header>

    <main class="p-4 sm:p-8">
      <div class="card p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <i data-lucide="list-checks" class="h-5 w-5 text-indigo-600"></i>
            <span>All Project Groups</span>
          </h2>
          <input id="search-box" type="text" placeholder="Search by topic or student" class="px-3 py-2 border rounded-lg text-sm w-full sm:w-64 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>

        <div id="project-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <p class="col-span-full text-center text-gray-500 p-8">Loading project data...</p>
        </div>
      </div>
    </main>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  
  // Client for Field Project Data
  const PROJECT_SUPABASE_URL = 'https://fuovcuzaxfkyqrridrgy.supabase.co';
  const PROJECT_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZjdXpheGZreXFycmlkcmd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NzIyMjAsImV4cCI6MjA2MTA0ODIyMH0._PkkfWXcn4j6cjBh-yLJjDevrmhuxKxVbcdQUSgCsSk';
  const supabaseProject = createClient(PROJECT_SUPABASE_URL, PROJECT_SUPABASE_KEY);

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

  function renderProjectList(projects) {
    const container = document.getElementById('project-list-container');
    container.innerHTML = '';

    if (!projects || projects.length === 0) {
        container.innerHTML = '<p class="col-span-full text-center text-gray-500 p-8">No projects found.</p>';
        return;
    }

    projects.forEach(project => {
        const teamMembersHTML = project.members.map(name => 
            `<span class="text-xs bg-gray-200 text-gray-800 px-2 py-1 rounded-full">${name}</span>`
        ).join('');

        let fileStatusHTML = '';
        if (project.file) {
            const { data: urlData } = supabaseProject.storage.from('FP').getPublicUrl(project.file.file_path);
            fileStatusHTML = `
                <div class="mt-4 bg-green-50 border border-green-200 p-3 rounded-lg flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-sm text-green-800">Submitted</p>
                    </div>
                    <a href="${urlData.publicUrl}" target="_blank" class="flex items-center gap-1.5 px-3 py-1.5 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition-colors text-xs shadow-sm">
                        <i data-lucide="download" class="w-3.5 h-3.5"></i>
                        <span>Download</span>
                    </a>
                </div>
            `;
        } else {
            fileStatusHTML = `
                <div class="mt-4 bg-yellow-50 border border-yellow-200 p-3 rounded-lg">
                    <p class="font-semibold text-sm text-yellow-800">Not Submitted Yet</p>
                </div>
            `;
        }

        const projectCard = document.createElement('div');
        projectCard.className = 'bg-white border p-4 rounded-lg shadow-sm flex flex-col';
        projectCard.innerHTML = `
            <div class="flex-grow">
                <p class="text-sm font-medium text-indigo-600">Topic #${project.topicId}</p>
                <h4 class="font-bold text-gray-900 mt-1">${project.topicName}</h4>
                <div class="mt-3">
                    <p class="text-xs font-semibold text-gray-500 mb-2">MEMBERS</p>
                    <div class="flex flex-wrap gap-2">${teamMembersHTML}</div>
                </div>
            </div>
            ${fileStatusHTML}
        `;
        container.appendChild(projectCard);
    });
    lucide.createIcons();
  }

  document.addEventListener("DOMContentLoaded", async () => {
    // Setup mentor profile info
    const profName = getCookie("name");
    if (profName) {
      const decodedName = decodeURIComponent(profName.replace(/\+/g, ' '));
      document.getElementById('prof-name').textContent = `Prof. ${decodedName}`;
      document.getElementById('prof-initial').textContent = decodedName.charAt(0).toUpperCase();
    }
     document.getElementById('logout-btn').addEventListener('click', (e) => { 
        e.preventDefault();
        document.cookie = "name=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        window.location.href = 'index.html';
    });
    
    // Fetch and process project data
    try {
        const [topicsRes, assignmentsRes, filesRes] = await Promise.all([
            supabaseProject.from('topics').select('*'),
            supabaseProject.from('projectassignments').select('topicid, students(name)'),
            supabaseProject.from('project_files').select('topic_id, file_path')
        ]);

        if (topicsRes.error) throw topicsRes.error;
        if (assignmentsRes.error) throw assignmentsRes.error;
        if (filesRes.error) throw filesRes.error;

        const assignmentsByTopic = assignmentsRes.data.reduce((acc, current) => {
            if (!acc[current.topicid]) {
                acc[current.topicid] = [];
            }
            acc[current.topicid].push(current.students.name);
            return acc;
        }, {});

        const filesByTopic = filesRes.data.reduce((acc, current) => {
            acc[current.topic_id] = current;
            return acc;
        }, {});

        const allProjects = topicsRes.data.map(topic => ({
            topicId: topic.topicid,
            topicName: topic.topicname,
            members: assignmentsByTopic[topic.topicid] || [],
            file: filesByTopic[topic.topicid] || null
        }));
        
        renderProjectList(allProjects);

        // Search functionality
        document.getElementById("search-box").addEventListener("input", e => {
            const filter = e.target.value.toLowerCase();
            const filteredProjects = allProjects.filter(p => {
                const topicText = p.topicName.toLowerCase();
                const membersText = p.members.join(' ').toLowerCase();
                return topicText.includes(filter) || membersText.includes(filter);
            });
            renderProjectList(filteredProjects);
        });

    } catch (error) {
        console.error("Failed to load project data:", error);
        document.getElementById('project-list-container').innerHTML = '<p class="col-span-full text-center text-red-500 p-8">Failed to load data. Please try again.</p>';
    }

    lucide.createIcons();
  });
</script>

</body>
</html>
