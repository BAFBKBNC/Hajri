<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ClassCount</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide-element"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06); }
    .header-gradient { background: linear-gradient(90deg, #4f46e5, #7c3aed); }
    .badge-safe { background-color: #dcfce7; color: #166534; }
    .badge-warning { background-color: #fef9c3; color: #854d0e; }
    .badge-danger { background-color: #fee2e2; color: #991b1b; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="flex min-h-screen">
  <div class="hidden md:flex flex-col w-64 bg-gray-900 text-gray-200 shadow-xl">
    <div class="flex items-center justify-center h-20 header-gradient text-white">
      <lucide-icon name="graduation-cap" class="h-8 w-8 mr-3"></lucide-icon>
      <span class="text-2xl font-bold">ClassCount</span>
    </div>
    <nav class="flex flex-col flex-grow p-4">
      <a href="#" class="flex items-center px-4 py-3 mt-2 font-semibold text-white bg-indigo-600 rounded-lg shadow-md">
        <lucide-icon name="layout-dashboard" class="h-5 w-5 mr-3"></lucide-icon>
        <span>Dashboard</span>
      </a>
      <a href="students.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <lucide-icon name="users" class="h-5 w-5 mr-3"></lucide-icon>
        <span>Students</span>
      </a>
      <a href="lectures.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <lucide-icon name="book-open" class="h-5 w-5 mr-3"></lucide-icon>
        <span>Lectures</span>
      </a>
      <a href="activities.html" class="flex items-center px-4 py-3 mt-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors duration-200">
        <lucide-icon name="puzzle" class="h-5 w-5 mr-3"></lucide-icon>
        <span>Activities</span>
      </a>
      <a href="login.html" class="flex items-center px-4 py-3 mt-auto text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors duration-200">
        <lucide-icon name="log-out" class="h-5 w-5 mr-3"></lucide-icon>
        <span>Logout</span>
      </a>
    </nav>
  </div>

  <div class="flex flex-col flex-1 overflow-y-auto">
    <header class="flex items-center justify-between h-20 px-4 sm:px-8 bg-white border-b shadow-sm sticky top-0 z-10">
      <h1 id="dashboard-title" class="text-xl sm:text-2xl font-bold text-gray-900">Mentor Dashboard</h1>
      <div class="flex items-center space-x-4">
        <div class="text-sm text-gray-600 text-right">
          <p class="font-semibold">Prof. Vaibhav Narule</p>
          <p id="current-date" class="text-xs"></p>
        </div>
        <img class="w-12 h-12 rounded-full object-cover border-2 border-indigo-500" src="https://i.pravatar.cc/150?img=6" alt="Mentor Avatar">
      </div>
    </header>

    <main class="p-4 sm:p-8 space-y-8">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="card p-6 flex items-center bg-gradient-to-br from-indigo-500 to-purple-600 text-white">
          <div class="p-3 rounded-full bg-white bg-opacity-20"><lucide-icon name="users-2" class="h-7 w-7"></lucide-icon></div>
          <div class="ml-4"><p class="text-sm opacity-80">Total Students</p><p id="total-students" class="text-3xl font-bold">0</p></div>
        </div>
        <div class="card p-6 flex items-center bg-gradient-to-br from-green-500 to-emerald-600 text-white">
          <div class="p-3 rounded-full bg-white bg-opacity-20"><lucide-icon name="user-check" class="h-7 w-7"></lucide-icon></div>
          <div class="ml-4"><p class="text-sm opacity-80">Safe Zone (&gt;75%)</p><p id="safe-zone" class="text-3xl font-bold">0</p></div>
        </div>
        <div class="card p-6 flex items-center bg-gradient-to-br from-yellow-500 to-amber-600 text-white">
          <div class="p-3 rounded-full bg-white bg-opacity-20"><lucide-icon name="user-cog" class="h-7 w-7"></lucide-icon></div>
          <div class="ml-4"><p class="text-sm opacity-80">Warning Zone</p><p id="warning-zone" class="text-3xl font-bold">0</p></div>
        </div>
        <div class="card p-6 flex items-center bg-gradient-to-br from-red-500 to-rose-600 text-white">
          <div class="p-3 rounded-full bg-white bg-opacity-20"><lucide-icon name="user-x" class="h-7 w-7"></lucide-icon></div>
          <div class="ml-4"><p class="text-sm opacity-80">Danger Zone (&lt;50%)</p><p id="danger-zone" class="text-3xl font-bold">0</p></div>
        </div>
      </div>

      <div class="card p-6">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2"><lucide-icon name="line-chart" class="h-5 w-5 text-indigo-600"></lucide-icon>Overall Attendance Trend (Last 30 Lectures)</h2>
        <div class="h-96 w-full"><canvas id="attendanceTrendChart"></canvas></div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="card p-6 lg:col-span-2"><h2 class="text-xl font-semibold mb-4 flex items-center gap-2"><lucide-icon name="bar-chart-2" class="h-5 w-5 text-blue-600"></lucide-icon>Subject-wise Attendance</h2><div class="h-80"><canvas id="subjectAttendanceChart"></canvas></div></div>
        <div class="card p-6"><h2 class="text-xl font-semibold mb-4 flex items-center gap-2"><lucide-icon name="pie-chart" class="h-5 w-5 text-purple-600"></lucide-icon>Student Distribution</h2><div class="h-80 flex items-center justify-center"><canvas id="distributionChart"></canvas></div></div>
      </div>

      <div class="card p-6">
        <h2 class="text-xl font-semibold mb-4 flex items-center gap-2"><lucide-icon name="calendar-clock" class="h-5 w-5 text-gray-700"></lucide-icon>Recent Lectures</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead class="bg-gray-50">
              <tr>
                <th class="p-3 font-semibold text-gray-600">Subject</th>
                <th class="p-3 font-semibold text-gray-600">Date</th>
                <th class="p-3 font-semibold text-gray-600 text-center">Attendees</th>
                <th class="p-3 font-semibold text-gray-600 text-right">Attendance (%)</th>
              </tr>
            </thead>
            <tbody id="recent-lectures-body"></tbody>
          </table>
        </div>
      </div>

      <div class="card p-6">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <lucide-icon name="list-checks" class="h-5 w-5 text-indigo-600"></lucide-icon>
            Student Records
          </h2>
          <div class="flex gap-2">
            <input id="search-box" type="text" placeholder="Search by name or ID"
              class="px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button onclick="downloadExcel()"
              class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 flex items-center gap-2">
              <lucide-icon name="download" class="h-4 w-4"></lucide-icon>
              <span>Excel</span>
            </button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table id="student-table" class="w-full text-left border-collapse">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-4 cursor-pointer font-semibold" onclick="sortTable(0)">ID</th>
                <th class="p-4 cursor-pointer font-semibold" onclick="sortTable(1)">Student Name</th>
                <th class="p-4 cursor-pointer font-semibold" onclick="sortTable(2)">Overall Attendance</th>
                <th class="p-4 font-semibold">Status</th>
                <th class="p-4 font-semibold">Actions</th>
              </tr>
            </thead>
            <tbody id="student-table-body"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
const supabaseClient = window.supabase.createClient("https://pwgdubtbvqnmivtupbvx.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3Z2R1YnRidnFubWl2dHVwYnZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwOTUzMTAsImV4cCI6MjA3MDY3MTMxMH0.kCn6JMv0kTQrkoJ7OmaxCbwZNzewRNtuOg-35nYXYXg");

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(";").shift();
  return null;
}

// ====== Excel Download ======
function downloadExcel() {
  let wb = XLSX.utils.book_new();
  let ws_data = [["ID","Student Name","Attendance %","Status"]];
  document.querySelectorAll("#student-table-body tr").forEach(tr=>{
    let cols = tr.querySelectorAll("td");
    ws_data.push([cols[0].innerText, cols[1].innerText, cols[2].innerText, cols[3].innerText]);
  });
  let ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "Student Records");
  XLSX.writeFile(wb, "student_records.xlsx");
}

// ====== Search Filter ======
document.addEventListener("input", e=>{
  if(e.target.id==="search-box"){
    let filter = e.target.value.toLowerCase();
    document.querySelectorAll("#student-table-body tr").forEach(tr=>{
      let text = tr.innerText.toLowerCase();
      tr.style.display = text.includes(filter) ? "" : "none";
    });
  }
});

// ====== Sort Table ======
let sortDirection = {};
function sortTable(colIndex) {
  const tbody = document.getElementById("student-table-body");
  let rows = Array.from(tbody.querySelectorAll("tr"));
  sortDirection[colIndex] = !sortDirection[colIndex];
  rows.sort((a,b)=>{
    let A = a.cells[colIndex].innerText;
    let B = b.cells[colIndex].innerText;
    if(colIndex===2) { A = parseInt(A); B = parseInt(B); }
    if(A < B) return sortDirection[colIndex] ? -1 : 1;
    if(A > B) return sortDirection[colIndex] ? 1 : -1;
    return 0;
  });
  tbody.innerHTML = "";
  rows.forEach(r=>tbody.appendChild(r));
}

// ====== Charts & Tables ======
/**
 * Helper function to parse 'DD/MM/YYYY' string into a valid Date object.
 * @param {string} dateString - The date string in DD/MM/YYYY format.
 * @returns {Date} A JavaScript Date object.
 */
function parseDDMMYYYY(dateString) {
    const [day, month, year] = dateString.split('/');
    // Month is 0-indexed in JavaScript Date constructor (0 for January)
    return new Date(year, month - 1, day);
}

/**
 * [MODIFIED] Renders a trend chart for the last 30 lectures.
 */
function renderTrendChart(lectures, students) {
    // 1. Sort all lectures chronologically to properly select the last ones
    const sortedLectures = [...lectures].sort((a, b) => parseDDMMYYYY(a.DATE) - parseDDMMYYYY(b.DATE));

    // 2. Get the last 30 lectures (or fewer if not available)
    const last30Lectures = sortedLectures.slice(-30);
    
    // 3. Aggregate data by date to average out multiple lectures on the same day
    const dailyData = last30Lectures.reduce((acc, lecture) => {
        const dateStr = lecture.DATE; // Use the original string as the key
        if (!acc[dateStr]) {
            acc[dateStr] = { totalAttendees: 0, lectureCount: 0 };
        }
        acc[dateStr].totalAttendees += lecture.attendees.length;
        acc[dateStr].lectureCount += 1;
        return acc;
    }, {});

    // 4. Prepare data for the chart, sorting the aggregated points by date
    const chartData = Object.keys(dailyData)
        .map(date => ({
            date: date,
            avgAttendance: students.length > 0 ? Math.round(
                (dailyData[date].totalAttendees / (dailyData[date].lectureCount * students.length)) * 100
            ) : 0
        }))
        .sort((a, b) => parseDDMMYYYY(a.date) - parseDDMMYYYY(b.date));

    const labels = chartData.map(item => parseDDMMYYYY(item.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }));
    const data = chartData.map(item => item.avgAttendance);

    new Chart(document.getElementById("attendanceTrendChart"), {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: "Average Attendance % (Last 30 Lectures)",
                data: data,
                borderColor: "#4f46e5",
                backgroundColor: "rgba(79, 70, 229, 0.1)",
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, max: 100 } }
        }
    });
}


/**
 * [MODIFIED] Shows the last 5 lectures that have already occurred.
 */
function renderRecentLectures(lectures, students) {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Compare dates only, not time
    const body = document.getElementById("recent-lectures-body");
    body.innerHTML = ""; 

    // Filter for past/present lectures and sort by most recent
    const sorted = [...lectures]
        .filter(l => parseDDMMYYYY(l.DATE) <= today)
        .sort((a, b) => parseDDMMYYYY(b.DATE) - parseDDMMYYYY(a.DATE));
    
    // Take the 5 most recent
    const recent = sorted.slice(0, 5);

    if (recent.length === 0) {
        body.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">No recent lectures found.</td></tr>`;
        return;
    }

    recent.forEach(l => {
        const count = l.attendees.length;
        const total = students.length;
        const percent = total > 0 ? Math.round((count / total) * 100) : 0;
        
        const formattedDate = parseDDMMYYYY(l.DATE).toLocaleDateString("en-GB", {
            day: 'numeric', month: 'long', year: 'numeric'
        });

        body.insertAdjacentHTML("beforeend", `
            <tr class="border-b last:border-b-0 hover:bg-gray-50 transition-colors">
                <td class="p-3 font-medium text-gray-800">${l.LECTURE}</td>
                <td class="p-3 text-sm text-gray-500">${formattedDate}</td>
                <td class="p-3 text-sm text-gray-700 font-medium text-center">${count} / ${total}</td>
                <td class="p-3 text-sm font-bold text-right text-indigo-600">${percent}%</td>
            </tr>`);
    });
}

// ====== Init ======
document.addEventListener("DOMContentLoaded", async () => {
  document.getElementById("current-date").textContent = new Date().toLocaleDateString("en-GB", { weekday:"long", year:"numeric", month:"long", day:"numeric" });
  
  // CHANGED: Redirect if no cookie is found
  const course = getCookie("course"); 
  if (!course) {
      window.location.href = "adminlogin.html";
      return; // Stop the script from running further
  }
  
  document.getElementById("dashboard-title").textContent = course.toUpperCase().replace('_', ' ') + " Mentor Dashboard";

  const studentsTable = `${course}_students`;
  const lecturesTable = `${course}_lectures`;

  const { data: students, error: studentsError } = await supabaseClient.from(studentsTable).select("id,name");
  const { data: lectures, error: lecturesError } = await supabaseClient.from(lecturesTable).select("DATE,LECTURE,attendees");

  if (studentsError || lecturesError || !students || !lectures) {
      console.error("Error fetching data:", studentsError || lecturesError);
      // Optionally display an error message to the user
      return;
  }

  const enriched = students.map(s => {
    const attended = lectures.filter(l => l.attendees && l.attendees.includes(s.id.toString())).length;
    const percentage = lectures.length ? Math.round((attended/lectures.length)*100) : 0;
    return { ...s, attendance: percentage };
  }).sort((a,b)=>b.attendance - a.attendance);

  // Render Student Records
  const tableBody = document.getElementById("student-table-body");
  tableBody.innerHTML = "";
  enriched.forEach(s => {
    const status = s.attendance >= 75 ? "Safe" : s.attendance >= 50 ? "Warning" : "Danger";
    const badge = status === "Safe" ? "badge-safe" : status === "Warning" ? "badge-warning" : "badge-danger";
    const row = `<tr class="border-b hover:bg-gray-50">
      <td class="p-4 text-sm text-gray-700">${s.id}</td>
      <td class="p-4 font-medium text-gray-900">${s.name}</td>
      <td class="p-4">${s.attendance}%</td>
      <td class="p-4"><span class="px-3 py-1 text-xs font-medium rounded-full ${badge}">${status}</span></td>
      <td class="p-4"><a href="adminprofile.html?id=${s.id}" class="text-indigo-600 hover:underline text-sm font-medium">View Details</a></td>
    </tr>`;
    tableBody.insertAdjacentHTML("beforeend", row);
  });

  document.getElementById("total-students").textContent = enriched.length;
  document.getElementById("safe-zone").textContent = enriched.filter(s=>s.attendance>=75).length;
  document.getElementById("warning-zone").textContent = enriched.filter(s=>s.attendance>=50&&s.attendance<75).length;
  document.getElementById("danger-zone").textContent = enriched.filter(s=>s.attendance<50).length;

  renderTrendChart(lectures, students);
  renderRecentLectures(lectures, students);

  new Chart(document.getElementById("distributionChart"), {
    type:"doughnut",
    data:{ labels:["Safe","Warning","Danger"], datasets:[{ data:[enriched.filter(s=>s.attendance>=75).length, enriched.filter(s=>s.attendance>=50&&s.attendance<75).length, enriched.filter(s=>s.attendance<50).length], backgroundColor:["#10b981","#f59e0b","#ef4444"] }] }
  });

  new Chart(document.getElementById("subjectAttendanceChart"), {
    type:"bar",
    data:{ labels:[...new Set(lectures.map(l=>l.LECTURE))],
      datasets:[{ label:"Avg %", data:[...new Set(lectures.map(l=>l.LECTURE))].map(sub=>{
        const ls=lectures.filter(l=>l.LECTURE===sub);
        const totalPossible = ls.length*students.length;
        const totalAttended = ls.reduce((s,l)=>s+(l.attendees ? l.attendees.length : 0),0);
        return totalPossible > 0 ? Math.round(totalAttended/totalPossible*100) : 0;
      }), backgroundColor:"#3b82f6" }]
    }
  });
});
</script>
</body>
</html>
