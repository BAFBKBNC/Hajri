<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add Lecture</title>
<style>
    body {
        font-family: 'Segoe UI', sans-serif;
        margin: 0;
        background-color: #f4f6fa;
        color: #333;
    }
    header {
        background-color: #243b8f;
        color: white;
        padding: 1rem 2rem;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    main {
        padding: 1rem;
        max-width: 800px;
        margin: auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    label {
        display: block;
        font-weight: bold;
        margin-top: 1rem;
        margin-bottom: 0.3rem;
    }
    select, input {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-bottom: 1rem;
        font-size: 1rem;
    }
    /* Responsive student list */
    .student-list {
        max-height: 350px;
        overflow-y: auto;
        border: 1px solid #ccc;
        border-radius: 6px;
        background-color: white;
    }
    .student-item {
        display: flex;
        align-items: center;
        padding: 0.6rem 0.8rem;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s ease;
    }
    .student-item:last-child {
        border-bottom: none;
    }
    .student-item:hover {
        background-color: #f9f9ff;
    }
    .student-item.selected {
        background-color: #e6f3ff;
    }
    .student-name {
        flex-grow: 1;
        font-size: 1rem;
        font-weight: 500;
        color: #333;
        word-break: break-word; /* Allows full wrapping */
        padding-right: 10px;
    }
    .student-checkbox {
        flex-shrink: 0;
        margin-left: auto; /* Push to far right */
        transform: scale(1.3);
        cursor: pointer;
    }
    .submit-btn {
        background-color: #243b8f;
        color: white;
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
    }
    .submit-btn:hover {
        background-color: #1b2e6d;
    }
</style>
<script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://pwgdubtbvqnmivtupbvx.supabase.co"; 
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3Z2R1YnRidnFubWl2dHVwYnZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwOTUzMTAsImV4cCI6MjA3MDY3MTMxMH0.kCn6JMv0kTQrkoJ7OmaxCbwZNzewRNtuOg-35nYXYXg"; 
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const studentListEl = document.getElementById("student-list");
    const searchInput = document.getElementById("student-search");

    let students = [];
    let selectedIdsSet = new Set();

    async function loadStudents() {
        const { data, error } = await supabase
            .from("students")
            .select("*")
            .order("NAME");

        if (error) {
            console.error("Error fetching students:", error);
            return;
        }
        students = data;
        renderStudents(students);
    }

    function renderStudents(list) {
        studentListEl.innerHTML = "";
        list.forEach(stu => {
            const div = document.createElement("div");
            div.classList.add("student-item");
            const checked = selectedIdsSet.has(stu.ID);

            const nameSpan = document.createElement("span");
            nameSpan.classList.add("student-name");
            nameSpan.textContent = stu.NAME;

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.value = stu.ID;
            checkbox.classList.add("student-checkbox");
            checkbox.checked = checked;

            if (checked) div.classList.add("selected");

            checkbox.addEventListener("change", () => {
                if (checkbox.checked) {
                    selectedIdsSet.add(stu.ID);
                } else {
                    selectedIdsSet.delete(stu.ID);
                }
                div.classList.toggle("selected", checkbox.checked);
            });

            div.addEventListener("click", (e) => {
                if (e.target.tagName !== "INPUT") {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event("change"));
                }
            });

            div.appendChild(nameSpan);
            
            studentListEl.appendChild(div);
        });
    }

    searchInput.addEventListener("input", () => {
        const term = searchInput.value.toLowerCase();
        const filtered = students.filter(s => s.NAME.toLowerCase().includes(term));
        renderStudents(filtered);
    });

    function formatDateToDDMMYYYY(dateStr) {
        const date = new Date(dateStr);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    document.getElementById("lecture-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const name = document.getElementById("lecture-name").value;
        const dateInput = document.getElementById("lecture-date").value;
        const dateFormatted = formatDateToDDMMYYYY(dateInput);
        const period = document.getElementById("lecture-period").value;

        const selectedIds = Array.from(selectedIdsSet);

        // Save lecture
        const { error } = await supabase
            .from("lectures")
            .insert([{
                DATE: dateFormatted,
                TIME: period,
                LECTURE: name,
                IDS: selectedIds.join(",")
            }]);

        if (error) {
            alert("Error adding lecture: " + error.message);
            return;
        }

        // Increment ATTENDED for selected students via bulk RPC
        const { error: rpcError } = await supabase.rpc('increment_attended_bulk', { ids: selectedIds });
        if (rpcError) {
            console.error("Error updating attendance:", rpcError);
        }

        alert("Lecture added and attendance updated!");
        document.getElementById("lecture-form").reset();
        selectedIdsSet.clear();
        renderStudents(students);
    });

    window.addEventListener("DOMContentLoaded", loadStudents);
</script>
</head>
<body>

<header>
    <h1>Add New Lecture</h1>
</header>

<main>
    <form id="lecture-form">
        <label for="lecture-name">Lecture Name</label>
        <select id="lecture-name" required>
            <option value="">-- Select Lecture --</option>
            <option>Financial Accounting – III</option>
            <option>Cost Accounting – I</option>
            <option>Basics of Service Sector</option>
            <option>Mutual Fund Distributor – I</option>
            <option>Big Data Analysis</option>
            <option>Field Project</option>
            <option>Marathi</option>
            <option>Sports</option>
        </select>

        <label for="lecture-date">Date</label>
        <input type="date" id="lecture-date" required>

        <label for="lecture-period">Period</label>
        <select id="lecture-period" required>
            <option value="">-- Select Period --</option>
            <option>4:00 PM - 5:00 PM</option>
            <option>5:00 PM - 6:00 PM</option>
            <option>6:00 PM - 7:00 PM</option>
        </select>

        <label for="student-search">Search Students</label>
        <input type="text" id="student-search" placeholder="Search by name" class="student-search">

        <div id="student-list" class="student-list"></div>

        <button type="submit" class="submit-btn">Save Lecture</button>
    </form>
</main>

</body>
</html>
