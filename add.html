<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add Lecture</title>
<style>
    body {
        font-family: 'Segoe UI', sans-serif;
        margin: 0;
        background-color: #f4f6fa;
        color: #333;
    }
    header {
        background-color: #243b8f;
        color: white;
        padding: 1rem 2rem;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    main {
        padding: 2rem;
        max-width: 800px;
        margin: auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    label {
        display: block;
        font-weight: bold;
        margin-top: 1rem;
        margin-bottom: 0.3rem;
    }
    select, input {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-bottom: 1rem;
    }
    .student-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ccc;
        border-radius: 6px;
        background-color: white;
        padding: 0;
    }
    .student-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.6rem 0.8rem;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .student-item:last-child {
        border-bottom: none;
    }
    .student-item:hover {
        background-color: #f9f9ff;
    }
    .student-item.selected {
        background-color: #e6f3ff;
    }
    .student-name {
        flex: 1;
        font-size: 0.95rem;
        font-weight: 500;
        color: #333;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .submit-btn {
        background-color: #243b8f;
        color: white;
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
    }
    .submit-btn:hover {
        background-color: #1b2e6d;
    }
</style>
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://pwgdubtbvqnmivtupbvx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3Z2R1YnRidnFubWl2dHVwYnZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwOTUzMTAsImV4cCI6MjA3MDY3MTMxMH0.kCn6JMv0kTQrkoJ7OmaxCbwZNzewRNtuOg-35nYXYXg";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const studentListEl = document.getElementById("student-list");
const searchInput = document.getElementById("student-search");
let students = [];
let selectedIds = new Set();

async function loadStudents() {
    const { data, error } = await supabase
        .from("students")
        .select("*")
        .order("name");

    if (error) {
        console.error("Error fetching students:", error);
        return;
    }
    students = data;
    renderStudents(students);
}

function renderStudents(list) {
    studentListEl.innerHTML = "";
    list.forEach(stu => {
        const div = document.createElement("div");
        div.classList.add("student-item");
        if (selectedIds.has(stu.id)) div.classList.add("selected");

        div.innerHTML = `<span class="student-name">${stu.name}</span>`;

        div.addEventListener("click", () => {
            if (selectedIds.has(stu.id)) {
                selectedIds.delete(stu.id);
                div.classList.remove("selected");
            } else {
                selectedIds.add(stu.id);
                div.classList.add("selected");
            }
        });

        studentListEl.appendChild(div);
    });
}

searchInput.addEventListener("input", () => {
    const term = searchInput.value.toLowerCase();
    const filtered = students.filter(s => s.name.toLowerCase().includes(term));
    renderStudents(filtered);
});

document.getElementById("lecture-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = document.getElementById("lecture-name").value;
    const dateInput = document.getElementById("lecture-date").value;
    const period = document.getElementById("lecture-period").value;

    // Format date as dd/mm/yyyy
    const dateParts = dateInput.split("-");
    const formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;

    const idsArray = Array.from(selectedIds);

    // Insert lecture
    const { error: insertError } = await supabase
        .from("lectures")
        .insert([{
            DATE: formattedDate,
            TIME: period,
            LECTURE: name,
            IDS: idsArray.join(",") || "EMPTY"
        }]);

    if (insertError) {
        alert("Error adding lecture: " + insertError.message);
        return;
    }

    // Increment attended for selected students
    for (let id of idsArray) {
        await supabase
            .from("students")
            .update({ attended: supabase.rpc('increment', { x: 1 }) }) // alternative is fetch current value then add 1
            .eq("id", id);
    }

    alert("Lecture added successfully!");
    selectedIds.clear();
    document.getElementById("lecture-form").reset();
    renderStudents(students);
});

window.addEventListener("DOMContentLoaded", loadStudents);
</script>
</head>
<body>

<header>
    <h1>Add New Lecture</h1>
</header>

<main>
    <form id="lecture-form">
        <label for="lecture-name">Lecture Name</label>
        <select id="lecture-name" required>
            <option value="">Select Lecture</option>
            <option>Financial Accounting – III</option>
            <option>Cost Accounting – I</option>
            <option>Basics of Service Sector</option>
            <option>Mutual Fund Distributor – I</option>
            <option>Big Data Analysis</option>
            <option>Field Project</option>
            <option>Marathi</option>
            <option>Sports</option>
        </select>

        <label for="lecture-date">Date</label>
        <input type="date" id="lecture-date" required>

        <label for="lecture-period">Period</label>
        <select id="lecture-period" required>
            <option value="">Select Period</option>
            <option>4:00 PM - 5:00 PM</option>
            <option>5:00 PM - 6:00 PM</option>
            <option>6:00 PM - 7:00 PM</option>
        </select>

        <label for="student-search">Search Students</label>
        <input type="text" id="student-search" placeholder="Search by name" class="student-search">

        <div id="student-list" class="student-list"></div>

        <button type="submit" class="submit-btn">Save Lecture</button>
    </form>
</main>

</body>
</html>
